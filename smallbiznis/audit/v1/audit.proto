syntax = "proto3";

package smallbiznis.audit.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/audit/v1;auditv1";

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

// ActorType enumerates the originator of an auditable change.
enum ActorType {
  // Defaults to unspecified; callers must provide a concrete actor.
  ACTOR_TYPE_UNSPECIFIED = 0;
  // Action performed by an interactive end-user.
  USER = 1;
  // Action performed by a service account or machine.
  SERVICE_ACCOUNT = 2;
  // Internal system generated or scheduled action.
  SYSTEM = 3;
}

// ActionType categorizes the kind of change recorded in the audit trail.
enum ActionType {
  // Default unspecified value; clients must select a specific action type.
  ACTION_TYPE_UNSPECIFIED = 0;

  // CRUD actions.
  CREATED = 1;
  UPDATED = 2;
  DELETED = 3;

  // Authentication lifecycle events.
  LOGIN = 10;
  LOGOUT = 11;

  // Authorization and state transitions.
  STATUS_CHANGED = 20;
  PERMISSION_CHANGED = 21;

  // Custom or domain-specific events not captured above.
  CUSTOM = 99;
}

// ======================================================
// MODELS
// ======================================================

// AuditEvent represents a tenant-facing log record stored for compliance and observability.
message AuditEvent {
  // Unique identifier for this audit entry.
  string id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];
  // Tenant namespace owning the audited resource.
  string tenant_id = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];

  // Classification of who performed the action.
  ActorType actor_type = 3 [(google.api.field_behavior) = REQUIRED];
  // Identifier of the actor (user_id, service account id, or system tag).
  string actor_id = 4 [(google.api.field_behavior) = REQUIRED];

  // Domain specific action name, e.g. "created_user" or "update_product".
  string action = 5 [(google.api.field_behavior) = REQUIRED];
  // ActionType for filtering and analytics.
  ActionType action_type = 6 [(google.api.field_behavior) = REQUIRED];

  // Hints for the audited resource.
  string resource_type = 7 [(google.api.field_behavior) = REQUIRED];
  // Identifier of the resource that changed.
  string resource_id = 8 [(google.api.field_behavior) = REQUIRED];

  // Minimal prior state captured for diffing.
  google.protobuf.Struct old_values = 9;
  // Minimal new state captured for diffing.
  google.protobuf.Struct new_values = 10;

  // Source IP address reported by the client.
  string ip_address = 11;
  // User agent string describing the client.
  string user_agent = 12;

  // Tenant-specified metadata for downstream systems.
  google.protobuf.Struct metadata = 13;

  // RFC3339 timestamp when the audit entry was generated.
  google.protobuf.Timestamp created_at = 14
      [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

// CreateAuditEventRequest stores a new audit entry tied to a tenant.
message CreateAuditEventRequest {
  // Tenant namespace responsible for the audited resource.
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED];

  // Actor metadata.
  ActorType actor_type = 2 [(google.api.field_behavior) = REQUIRED];
  // Actor identifier (user, service account, or system constant).
  string actor_id = 3 [(google.api.field_behavior) = REQUIRED];

  // Domain action details.
  string action = 4 [(google.api.field_behavior) = REQUIRED];
  ActionType action_type = 5 [(google.api.field_behavior) = REQUIRED];

  // Target resource context.
  string resource_type = 6 [(google.api.field_behavior) = REQUIRED];
  string resource_id = 7 [(google.api.field_behavior) = REQUIRED];

  // Optional snapshot of prior state for comparator.
  google.protobuf.Struct old_values = 8;
  // Optional snapshot of new state for comparator.
  google.protobuf.Struct new_values = 9;

  // Optional network context reported by the client.
  string ip_address = 10;
  string user_agent = 11;

  // Tenant supplied metadata for connectors or enrichment.
  google.protobuf.Struct metadata = 12;
}

// CreateAuditEventResponse returns the persisted audit event with metadata.
message CreateAuditEventResponse {
  // Stored audit entry with server generated timestamps.
  AuditEvent event = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ListAuditEventsRequest scopes audit history retrieval.
message ListAuditEventsRequest {
  // Tenant namespace scope for the query.
  string tenant_id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];
  // Optional resource_type filter.
  string resource_type = 2;
  // Optional resource_id filter.
  string resource_id = 3;
  // Optional actor_id filter per tenant owner.
  string actor_id = 4;
  // Optional action_type filter for severity or category.
  ActionType action_type = 5;
  // Maximum records to return; may be capped by the service.
  int32 page_size = 6;
  // Token returned by a previous ListAuditEventsResponse.
  string page_token = 7;
}

// ListAuditEventsResponse pages through audit entries.
message ListAuditEventsResponse {
  // Matching audit entries sorted by created_at descending.
  repeated AuditEvent events = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Token clients use to fetch the next page.
  string next_page_token = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// GetAuditEventRequest retrieves a single audit entry by id.
message GetAuditEventRequest {
  // Identifier of the audit entry to fetch.
  string id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];
}

// GetAuditEventResponse returns the requested audit entry.
message GetAuditEventResponse {
  // The audit entry requested by id.
  AuditEvent event = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ======================================================
// SERVICE
// ======================================================

// AuditService records tenant audit trails and exposes retrieval APIs for compliance.
service AuditService {

  // CreateAuditEvent stores an audit log entry; requires tenant-scoped API key and is idempotent for duplicate requests.
  rpc CreateAuditEvent(CreateAuditEventRequest)
      returns (CreateAuditEventResponse) {
    option (google.api.http) = {
      post: "/v1/audit-events"
      body: "*"
    };
  }

  // ListAuditEvents returns tenant events filtered by resource or actor; tenant_id must match caller context.
  rpc ListAuditEvents(ListAuditEventsRequest)
      returns (ListAuditEventsResponse) {
    option (google.api.http) = {
      get: "/v1/audit-events"
    };
  }

  // GetAuditEvent fetches a single entry by id; idempotent and tenant-scoped.
  rpc GetAuditEvent(GetAuditEventRequest)
      returns (GetAuditEventResponse) {
    option (google.api.http) = {
      get: "/v1/audit-events/{id}"
    };
  }
}
