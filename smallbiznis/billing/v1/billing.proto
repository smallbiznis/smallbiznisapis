syntax = "proto3";

package smallbiznis.billing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/billing/v1;billingv1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/api/annotations.proto";


// =======================================================================
// ENUMS
// =======================================================================
enum BillingErrorCode {
  BILLING_ERROR_CODE_UNSPECIFIED = 0;

  BILLING_ERROR_USAGE_KEY_NOT_FOUND = 1;

  BILLING_ERROR_INSUFFICIENT_BALANCE = 2;
  BILLING_ERROR_TRIAL_EXPIRED        = 3;
  BILLING_ERROR_TRIAL_NOT_INITIALIZED = 4;

  BILLING_ERROR_INTERNAL = 100;
}

message BillingError {
  BillingErrorCode code = 1;
  string message = 2;
}


// =======================================================================
// DOMAIN MODELS
// =======================================================================

// Status trial tenant (aktif / expired + sisa saldo)
message TrialStatus {
  bool enabled = 1; // trial aktif
  bool expired = 2; // trial sudah habis

  int64 balance_cents = 3; // sisa trial credit

  google.protobuf.Timestamp trial_start_at = 4;
  google.protobuf.Timestamp trial_end_at   = 5;
}

// Balance hanya untuk trial (seperti GCP Free Trial)
message Balance {
  string tenant_id = 1;

  // free trial credit
  int64 trial_balance_cents = 2;

  google.protobuf.Timestamp updated_at = 3;
}

// Aturan harga untuk usage-based metric
message PricingRule {
  string usage_key = 1;
  int64 cost_per_unit = 2;
  int64 min_charge    = 3;
  int64 max_charge    = 4;
}

// Event penggunaan service (usage-based billing)
message UsageEvent {
  string tenant_id = 1;
  string usage_key = 2;
  int64 amount     = 3;
  google.protobuf.Struct metadata = 4;
}

// Catatan usage yang sudah dihitung
message UsageRecord {
  string id = 1;
  string tenant_id = 2;

  string usage_key = 3;
  int64 amount     = 4;
  int64 cost_cents = 5;

  // sisa balance trial setelah deduction
  int64 trial_balance_left = 6;

  google.protobuf.Struct metadata = 7;
  google.protobuf.Timestamp created_at = 8;
}


// =======================================================================
// ENTRYPOINT DARI SUBSCRIPTION SERVICE
// =======================================================================

// Dipanggil saat tenant memilih plan & subscription dibuat
message OnSubscriptionCreatedRequest {
  string tenant_id = 1;
  string plan_code = 2;
  int32 trial_days = 3; // dikirim langsung dari SubscriptionService
}

message OnSubscriptionCreatedResponse {
  TrialStatus trial = 1;
}


// =======================================================================
// REQUEST / RESPONSE
// =======================================================================

// INTERNAL ONLY: opsional untuk repair atau migration
message InitTrialRequest {
  string tenant_id = 1;
  int64 initial_balance_cents = 2;
  int32 trial_days = 3;
}

message InitTrialResponse {
  TrialStatus trial = 1;
  BillingError error = 2;
}

message GetTrialStatusRequest {
  string tenant_id = 1;
}

message GetTrialStatusResponse {
  TrialStatus trial = 1;
  BillingError error = 2;
}

message RecordUsageResponse {
  bool success = 1;
  BillingErrorCode error_code = 2;

  int64 cost_cents = 3;
  int64 remaining_trial_balance_cents = 4;
}

message CheckTrialAndBalanceRequest {
  string tenant_id = 1;
}

message CheckTrialAndBalanceResponse {
  bool trial_active = 1;
  bool has_balance  = 2;
  bool allowed      = 3;

  TrialStatus trial = 4;

  BillingError error = 5;
}

message GetBalanceRequest {
  string tenant_id = 1;
}

message GetBalanceResponse {
  Balance balance = 1;
  BillingError error = 2;
}


// =======================================================================
// BILLING SERVICE
// =======================================================================
service BillingService {

  // Dipanggil oleh SubscriptionService setelah subscription dibuat
  rpc OnSubscriptionCreated(OnSubscriptionCreatedRequest)
      returns (OnSubscriptionCreatedResponse);

  // INTERNAL â€” bukan bagian dari onboarding
  // rpc InitTrial(InitTrialRequest)
  //     returns (InitTrialResponse);

  rpc GetTrialStatus(GetTrialStatusRequest)
      returns (GetTrialStatusResponse);

  rpc RecordUsage(UsageEvent)
      returns (RecordUsageResponse);

  rpc CheckTrialAndBalance(CheckTrialAndBalanceRequest)
      returns (CheckTrialAndBalanceResponse);

  rpc GetBalance(GetBalanceRequest)
      returns (GetBalanceResponse);
}
