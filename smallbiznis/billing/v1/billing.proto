syntax = "proto3";

package smallbiznis.billing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/billing/v1;billingv1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/api/annotations.proto";


// ===============================================================
// ENUMS
// ===============================================================
enum BillingErrorCode {
  BILLING_ERROR_CODE_UNSPECIFIED = 0;

  // pricing / usage
  BILLING_ERROR_USAGE_KEY_NOT_FOUND = 1;

  // balance & trial
  BILLING_ERROR_INSUFFICIENT_BALANCE = 2;
  BILLING_ERROR_TRIAL_EXPIRED        = 3;
  BILLING_ERROR_TRIAL_NOT_INITIALIZED = 4;

  BILLING_ERROR_INTERNAL = 100;
}

message BillingError {
  BillingErrorCode code = 1;
  string message = 2;
}

// ===============================================================
// DOMAIN MODELS
// ===============================================================

message TrialStatus {
  bool enabled = 1;
  bool expired = 2;

  // total trial credit allocated for this tenant
  int64 balance_cents = 3;

  google.protobuf.Timestamp trial_start_at = 4;
  google.protobuf.Timestamp trial_end_at   = 5;
}

message Balance {
  string tenant_id = 1;

  int64 trial_balance_cents = 2;
  int64 paid_balance_cents  = 3;

  google.protobuf.Timestamp updated_at = 4;
}

message PricingRule {
  string usage_key = 1;
  int64 cost_per_unit = 2;
  int64 min_charge    = 3;
  int64 max_charge    = 4;
}

message UsageEvent {
  string tenant_id = 1;
  string usage_key = 2;
  int64 amount     = 3;
  google.protobuf.Struct metadata = 4;
}

message UsageRecord {
  string id = 1;
  string tenant_id = 2;

  string usage_key = 3;
  int64 amount     = 4;
  int64 cost_cents = 5;

  // balances after this usage is applied
  int64 trial_balance_left = 6;
  int64 paid_balance_left  = 7;

  google.protobuf.Struct metadata      = 8;
  google.protobuf.Timestamp created_at = 9;
}

// ===============================================================
// SUBSCRIPTION EVENT ENTRYPOINT (MAIN ONBOARDING PATH)
// ===============================================================
message OnSubscriptionCreatedRequest {
  string tenant_id = 1;
  string plan_code = 2;
  int32 trial_days = 3; // comes from SubscriptionPlan.default_trial_days
}

message OnSubscriptionCreatedResponse {
  TrialStatus trial = 1;
}

// ===============================================================
// REQUEST / RESPONSE
// ===============================================================

// INTERNAL / ADMIN USE ONLY – NOT USED IN NORMAL ONBOARDING FLOW
message InitTrialRequest {
  string tenant_id = 1;
  int64 initial_balance_cents = 2;
  int32 trial_days = 3;
}

message InitTrialResponse {
  TrialStatus trial   = 1;
  BillingError error  = 2;
}

message GetTrialStatusRequest {
  string tenant_id = 1;
}

message GetTrialStatusResponse {
  TrialStatus trial   = 1;
  BillingError error  = 2;
}

message RecordUsageResponse {
  bool success = 1;
  BillingErrorCode error_code = 2;

  int64 cost_cents                       = 3;
  int64 remaining_trial_balance_cents    = 4;
  int64 remaining_paid_balance_cents     = 5;
}

message CheckTrialAndBalanceRequest {
  string tenant_id = 1;
}

message CheckTrialAndBalanceResponse {
  bool trial_active = 1;
  bool has_balance  = 2;
  bool allowed      = 3;

  TrialStatus trial = 4;
  BillingError error = 5;
}

message GetBalanceRequest {
  string tenant_id = 1;
}

message GetBalanceResponse {
  Balance balance   = 1;
  BillingError error = 2;
}

// ===============================================================
// BILLING SERVICE
// ===============================================================
service BillingService {

  // Main onboarding entrypoint:
  // called by SubscriptionService AFTER a subscription is created.
  rpc OnSubscriptionCreated(OnSubscriptionCreatedRequest)
      returns (OnSubscriptionCreatedResponse) {
    option (google.api.http) = {
      post: "/v1/billing/subscriptions:on-created"
      body: "*"
    };
  }

  // // INTERNAL ONLY – admin/ops, not used in tenant onboarding.
  // rpc InitTrial(InitTrialRequest) returns (InitTrialResponse) {
  //   option (google.api.http) = {
  //     post: "/v1/billing/trial:init"
  //     body: "*"
  //   };
  // }

  rpc GetTrialStatus(GetTrialStatusRequest)
      returns (GetTrialStatusResponse) {
    option (google.api.http) = {
      get: "/v1/billing/trial/status"
    };
  }

  // Usage-based billing entrypoint, used by other services.
  rpc RecordUsage(UsageEvent)
      returns (RecordUsageResponse) {
    option (google.api.http) = {
      post: "/v1/billing/usage"
      body: "*"
    };
  }

  rpc CheckTrialAndBalance(CheckTrialAndBalanceRequest)
      returns (CheckTrialAndBalanceResponse) {
    option (google.api.http) = {
      get: "/v1/billing/check"
    };
  }

  rpc GetBalance(GetBalanceRequest)
      returns (GetBalanceResponse) {
    option (google.api.http) = {
      get: "/v1/billing/balance"
    };
  }
}
