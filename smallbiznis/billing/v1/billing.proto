syntax = "proto3";

package smallbiznis.billing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/billing/v1;billingv1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/api/annotations.proto";


// ==========================================================
// ENUM â€“ Standardized Billing Error Codes
// ==========================================================
enum BillingErrorCode {
  BILLING_ERROR_CODE_UNSPECIFIED       = 0;

  // Pricing-related
  BILLING_ERROR_USAGE_KEY_NOT_FOUND    = 1;

  // Balance & trial
  BILLING_ERROR_INSUFFICIENT_BALANCE   = 2;
  BILLING_ERROR_TRIAL_EXPIRED          = 3;
  BILLING_ERROR_TRIAL_NOT_INITIALIZED  = 4;

  // Internal errors
  BILLING_ERROR_INTERNAL                = 100;
}

// ==========================================================
// Message: BillingError (standardized error envelope)
// ==========================================================
message BillingError {
  BillingErrorCode code = 1;
  string message = 2;
}


// ==========================================================
// Models
// ==========================================================

message TrialStatus {
  bool enabled = 1;
  bool expired = 2;

  int64 balance_cents = 3;

  google.protobuf.Timestamp trial_start_at = 4;
  google.protobuf.Timestamp trial_end_at   = 5;
}

message Balance {
  string tenant_id = 1;
  int64 balance_cents = 2;
  google.protobuf.Timestamp updated_at = 3;
}

message PricingRule {
  string usage_key = 1;
  int64 cost_per_unit = 2;     // base cost per unit
  int64 min_charge = 3;        // minimum charge
  int64 max_charge = 4;        // cap on charge
}

// usage event from service usage
message UsageEvent {
  string tenant_id = 1;
  string usage_key = 2;
  int64 amount = 3;
  google.protobuf.Struct metadata = 4;
}

message UsageRecord {
  string id = 1;
  string tenant_id = 2;
  string usage_key = 3;
  int64 amount = 4;
  int64 cost_cents = 5;
  int64 balance_left = 6;
  google.protobuf.Struct metadata = 7;
  google.protobuf.Timestamp created_at = 8;
}


// ==========================================================
// Event Envelope (EventCatalog standard)
// ==========================================================

message BillingEventEnvelope {
  string event_id = 1;
  string event_type = 2; // smallbiznis.billing.<entity>.<action>.v1
  google.protobuf.Timestamp occurred_at = 3;

  // raw event payload, flexible
  google.protobuf.Struct data = 4;

  // metadata (tenant_id, source, trace_id, user_id, etc.)
  google.protobuf.Struct metadata = 5;
}


// ==========================================================
// Service RPC Definitions
// ==========================================================

// 1. Init Trial (initial credit assigned)
message InitTrialRequest {
  string tenant_id = 1;
  int64 initial_balance_cents = 2;
  int32 trial_days = 3;
}

message InitTrialResponse {
  TrialStatus trial = 1;
  BillingError error = 2;
}

// 2. Get Trial Status
message GetTrialStatusRequest {
  string tenant_id = 1;
}

message GetTrialStatusResponse {
  TrialStatus trial = 1;
  BillingError error = 2;
}

// 3. Record Usage (usage-based cost billing)
message RecordUsageResponse {
  bool success = 1;
  BillingErrorCode error_code = 2;

  int64 cost_cents = 3;
  int64 remaining_balance_cents = 4;
}

// 4. Check trial + balance gating
message CheckTrialAndBalanceRequest {
  string tenant_id = 1;
}

message CheckTrialAndBalanceResponse {
  bool trial_active = 1;
  bool has_balance = 2;
  bool allowed = 3;

  TrialStatus trial = 4;

  BillingError error = 5;
}

// 5. Get Balance Only
message GetBalanceRequest {
  string tenant_id = 1;
}

message GetBalanceResponse {
  Balance balance = 1;
  BillingError error = 2;
}


// ==========================================================
// Billing Service
// ==========================================================
service BillingService {

  rpc InitTrial(InitTrialRequest) returns (InitTrialResponse) {
    option (google.api.http) = {
      post: "/v1/billing/trial:init"
      body: "*"
    };
  }

  rpc GetTrialStatus(GetTrialStatusRequest) returns (GetTrialStatusResponse) {
    option (google.api.http) = {
      get: "/v1/billing/trial/status"
    };
  }

  rpc RecordUsage(UsageEvent) returns (RecordUsageResponse) {
    option (google.api.http) = {
      post: "/v1/billing/usage"
      body: "*"
    };
  }

  rpc CheckTrialAndBalance(CheckTrialAndBalanceRequest)
       returns (CheckTrialAndBalanceResponse) {
    option (google.api.http) = {
      get: "/v1/billing/check"
    };
  }

  rpc GetBalance(GetBalanceRequest) returns (GetBalanceResponse) {
    option (google.api.http) = {
      get: "/v1/billing/balance"
    };
  }
}
