syntax = "proto3";

package smallbiznis.billing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/billing/v1;billingv1";

import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";

// ============================================================
// ENUMS
// ============================================================

enum BillingPeriodStatus {
  BILLING_PERIOD_STATUS_UNSPECIFIED = 0;
  OPEN = 1;          // collecting usage
  PROCESSING = 2;    // generating invoice
  CLOSED = 3;        // locked
}

// ============================================================
// DOMAIN MODELS
// ============================================================

message BillingPeriod {
  string id = 1;
  string subscription_id = 2;

  google.protobuf.Timestamp period_start = 3;
  google.protobuf.Timestamp period_end = 4;

  BillingPeriodStatus status = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

// ============================================================
// REQUEST / RESPONSE
// ============================================================

message GetBillingPeriodRequest {
  string id = 1;
}

message GetBillingPeriodResponse {
  BillingPeriod period = 1;
}

message ListBillingPeriodsRequest {
  string subscription_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListBillingPeriodsResponse {
  repeated BillingPeriod periods = 1;
  string next_page_token = 2;
}

message OpenBillingPeriodRequest {
  string subscription_id = 1;
}

message OpenBillingPeriodResponse {
  BillingPeriod period = 1;
}

message CloseBillingPeriodRequest {
  string id = 1;
}

message CloseBillingPeriodResponse {
  BillingPeriod period = 1;
}

// ============================================================
// BILLING PERIOD SERVICE
// ============================================================

service BillingPeriodService {

  rpc OpenBillingPeriod(OpenBillingPeriodRequest)
      returns (OpenBillingPeriodResponse) {
    option (google.api.http) = {
      post: "/v1/billing-periods:open"
      body: "*"
    };
  }

  rpc CloseBillingPeriod(CloseBillingPeriodRequest)
      returns (CloseBillingPeriodResponse) {
    option (google.api.http) = {
      post: "/v1/billing-periods/{id}:close"
      body: "*"
    };
  }

  rpc GetBillingPeriod(GetBillingPeriodRequest)
      returns (GetBillingPeriodResponse) {
    option (google.api.http) = {
      get: "/v1/billing-periods/{id}"
    };
  }

  rpc ListBillingPeriods(ListBillingPeriodsRequest)
      returns (ListBillingPeriodsResponse) {
    option (google.api.http) = {
      get: "/v1/billing-periods"
    };
  }
}
