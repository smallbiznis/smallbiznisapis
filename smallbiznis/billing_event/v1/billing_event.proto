syntax = "proto3";

package smallbiznis.billing_event.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/billing_event/v1;billingeventv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "smallbiznis/event/v1/event.proto";

// BillingEvent wraps the generic Event message with billing-specific context for
// storage and webhook delivery.
message BillingEvent {
  // Unique identifier for the event.
  string id = 1;
  // Canonical subject string (see EventSubject in event_catalog.proto).
  string subject = 2;
  // Tenant that owns the affected resource.
  string tenant_id = 3;
  // Resource identifier related to the event (subscription, invoice, customer).
  string resource_id = 4;
  // Structured payload specific to the subject.
  google.protobuf.Struct payload = 5;
  // Timestamp when the event was created.
  google.protobuf.Timestamp created_at = 6;
}

// WebhookEndpoint defines destinations for tenant billing events.
message WebhookEndpoint {
  string id = 1;
  string tenant_id = 2;
  string url = 3;
  bool active = 4;
}

// Request to deliver an event to a webhook endpoint.
message DeliverWebhookRequest {
  string event_id = 1;
  string endpoint_id = 2;
}

// Response indicating webhook delivery success.
message DeliverWebhookResponse {
  bool delivered = 1;
}

// BillingEventService persists billing events and manages webhook delivery.
service BillingEventService {
  // Emit and store a billing event using the generic envelope for downstream
  // processing.
  rpc EmitEvent(smallbiznis.event.v1.Event) returns (BillingEvent) {
    option (google.api.http) = {
        post: "/v1/events"
        body: "*"
    };
  };

  // Deliver a stored event to a tenant-configured webhook endpoint.
  rpc DeliverWebhook(DeliverWebhookRequest) returns (DeliverWebhookResponse);
}
