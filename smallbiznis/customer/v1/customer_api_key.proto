syntax = "proto3";

package smallbiznis.customer.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/customer/v1;customerv1";

import "google/protobuf/timestamp.proto";

// ApiKey represents a tenant-owned credential for server-to-server API access.
// Keys are never attached to customers and must be scoped to a tenant.
message ApiKey {
  // Unique identifier for the API key record.
  string id = 1;

  // Tenant that owns and manages this API key.
  string tenant_id = 2;

  // Friendly name for operator reference (e.g., "Production key").
  string name = 3;

  // Safe prefix that can be logged and shown to users (e.g., "sb_live_abc123").
  string key_prefix = 4;

  // Hash of the secret key material (bcrypt/argon2). Plaintext is never stored.
  string hashed_key = 5;

  // Indicates whether the key has been revoked and should be rejected.
  bool revoked = 6;

  // Creation and update timestamps.
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;

  // Timestamp of the last successful usage, useful for rotation policies.
  google.protobuf.Timestamp last_used_at = 9;

  // Allowed scopes for this key (e.g., "usage:write", "invoice:read").
  repeated string scopes = 10;

  // Optional expiration timestamp after which the key is invalid.
  google.protobuf.Timestamp expires_at = 11;
}

// Request to create a new API key for a tenant.
message CreateApiKeyRequest {
  // Tenant that will own the key.
  string tenant_id = 1;
  // Friendly name to identify the key.
  string name = 2;
  // Scopes granted to the key.
  repeated string scopes = 3;
}

// Response containing the stored key record and the one-time plaintext value.
message CreateApiKeyResponse {
  // Persisted key metadata.
  ApiKey key = 1;
  // Plain text secret returned once at creation time.
  string plain_text_key = 2;
}

// Request to list keys for a tenant.
message ListApiKeysRequest {
  // Tenant whose keys should be returned.
  string tenant_id = 1;
}

// Response containing all API keys for the tenant.
message ListApiKeysResponse {
  repeated ApiKey keys = 1;
}

// Request to revoke an API key.
message RevokeApiKeyRequest {
  // Tenant that owns the key (authorization guard).
  string tenant_id = 1;
  // Identifier of the key to revoke.
  string key_id = 2;
}

// Response confirming revocation status.
message RevokeApiKeyResponse {
  bool success = 1;
}

// Request to rotate an API key, returning a new key and revoking the old one.
message RotateApiKeyRequest {
  // Tenant that owns the key.
  string tenant_id = 1;
  // Identifier of the key to rotate.
  string key_id = 2;
}

// Response containing both the revoked key and the newly issued key.
message RotateApiKeyResponse {
  ApiKey old_key = 1;
  ApiKey new_key = 2;
  string new_plain_text_key = 3;
}

// ApiKeyService manages tenant-scoped API keys used for accessing the billing
// platform. Customers never receive API keys.
service ApiKeyService {
  // Create a new API key for the tenant, returning the plaintext once.
  rpc CreateApiKey(CreateApiKeyRequest) returns (CreateApiKeyResponse);

  // List all API keys for a tenant.
  rpc ListApiKeys(ListApiKeysRequest) returns (ListApiKeysResponse);

  // Revoke an existing API key so it can no longer be used.
  rpc RevokeApiKey(RevokeApiKeyRequest) returns (RevokeApiKeyResponse);

  // Rotate an API key by issuing a new secret and revoking the old one.
  rpc RotateApiKey(RotateApiKeyRequest) returns (RotateApiKeyResponse);
}
