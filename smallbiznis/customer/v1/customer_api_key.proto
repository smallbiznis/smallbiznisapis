syntax = "proto3";

package smallbiznis.customer.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/customer/v1;customerv1";

import "google/protobuf/timestamp.proto";

// ApiKey represents a long-lived credential that authorizes tenant scoped requests.
message ApiKey {
  // Unique, monotonic identifier for this API key metadata.
  string id = 1;
  // Tenant namespace that owns this key.
  string tenant_id = 2;
  // Human friendly label such as "Production Key" that tenants control.
  string name = 3;
  // Safe prefix that is returned in cleartext for logging and pattern matching.
  string key_prefix = 4;
  // One-way hash of the secret portion using bcrypt/argon2; used for verification.
  string hashed_key = 5;
  // Flag indicating whether the key has been revoked and no longer accepts requests.
  bool revoked = 6;
  // RFC3339 timestamp when the key was created; immutable audit field.
  google.protobuf.Timestamp created_at = 7;
  // RFC3339 timestamp when the key metadata last changed (name, revoke status, scopes).
  google.protobuf.Timestamp updated_at = 8;
  // RFC3339 timestamp for the most recent API call authenticated with this key.
  google.protobuf.Timestamp last_used_at = 9;
  // Tenant granted permissions, e.g. ["usage:write","invoice:read"], enforced by gateway.
  repeated string scopes = 10;
}

// CreateApiKeyRequest is submitted by tenants to provision a new credential.
message CreateApiKeyRequest {
  // Tenant namespace that will own the key and must match auth context.
  string tenant_id = 1;
  // Friendly label that makes the key discoverable in console lists.
  string name = 2;
  // Desired permission set for the key; subset of tenant allowed scopes.
  repeated string scopes = 3;
}

// CreateApiKeyResponse returns the stored key metadata and the one-time secret.
message CreateApiKeyResponse {
  // Persisted ApiKey metadata; secret is never retrievable after creation.
  ApiKey key = 1;
  // Plaintext secret (prefix+hash) returned only once so callers must store it securely.
  string plain_text_key = 2;
}

// ListApiKeysRequest scopes the listing to a tenant namespace.
message ListApiKeysRequest {
  // Tenant namespace for which we enumerate API keys.
  string tenant_id = 1;
}

// ListApiKeysResponse streams back the tenant's stored keys with metadata.
message ListApiKeysResponse {
  // Tenant owned API keys sorted by creation date.
  repeated ApiKey keys = 1;
}

// RevokeApiKeyRequest invalidates the supplied key_id for a tenant namespace.
message RevokeApiKeyRequest {
  // Tenant namespace that owns the key being revoked.
  string tenant_id = 1;
  // Identifier of the ApiKey to revoke.
  string key_id = 2;
}

// RevokeApiKeyResponse acknowledges successful revocation.
message RevokeApiKeyResponse {
  // True when revocation succeeded and the key is no longer accepted.
  bool success = 1;
}

// RotateApiKeyRequest instructs the service to create a replacement key.
message RotateApiKeyRequest {
  // Tenant namespace that owns the key pair.
  string tenant_id = 1;
  // Admin-supplied identifier of the key to rotate.
  string key_id = 2;
}

// RotateApiKeyResponse includes both the previous metadata and the new plaintext secret.
message RotateApiKeyResponse {
  // Metadata for the still-valid old key.
  ApiKey old_key = 1;
  // Newly created metadata for the replacement credential.
  ApiKey new_key = 2;
  // Plaintext secret for the replacement key, only returned once.
  string new_plain_text_key = 3;
}

// ApiKeyService manages tenant-scoped API keys for Billing-as-a-Service clients.
service ApiKeyService {
  // Creates a key, enforces tenant ownership, and returns the new plaintext secret.
  rpc CreateApiKey(CreateApiKeyRequest) returns (CreateApiKeyResponse);
  // Lists the recipient tenant's keys with their metadata.
  rpc ListApiKeys(ListApiKeysRequest) returns (ListApiKeysResponse);
  // Revokes a key, leaving it unusable without deleting metadata.
  rpc RevokeApiKey(RevokeApiKeyRequest) returns (RevokeApiKeyResponse);
  // Generates a replacement key while keeping the old key valid until revoked.
  rpc RotateApiKey(RotateApiKeyRequest) returns (RotateApiKeyResponse);
}
