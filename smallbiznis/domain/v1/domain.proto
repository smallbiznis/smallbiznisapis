syntax = "proto3";

package smallbiznis.domain.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/domain/v1;domainv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum DomainVerificationMethod {
  DOMAIN_VERIFICATION_METHOD_UNSPECIFIED = 0;
  DNS = 1;     // TXT record
  FILE = 2;    // File verification (e.g. /.well-known)
  MANUAL = 3;  // Mark verified manually (enterprise customers)
}

enum DomainVerificationStatus {
  DOMAIN_VERIFICATION_STATUS_UNSPECIFIED = 0;
  PENDING = 1;
  VERIFIED = 2;
  FAILED = 3;
}

enum DomainSslStatus {
  DOMAIN_SSL_STATUS_UNSPECIFIED = 0;
  DOMAIN_SSL_STATUS_NOT_REQUESTED = 1;
  DOMAIN_SSL_STATUS_REQUESTING = 2;
  DOMAIN_SSL_STATUS_PROVISIONED = 3;
  DOMAIN_SSL_STATUS_FAILED = 4;
}

// ======================================================
// MODELS
// ======================================================

message Domain {
  string id = 1;
  string tenant_id = 2;

  string domain = 3;

  DomainVerificationMethod verification_method = 4;
  DomainVerificationStatus verification_status = 5;

  // Random TXT token for DNS verification
  string verification_token = 6;

  bool is_primary = 7;

  DomainSslStatus ssl_status = 8;

  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

// ======================================================
// EVENTS (NATS)
// ======================================================

message DomainCreatedEvent {
  string domain_id = 1;
  string tenant_id = 2;
  string domain = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

message DomainVerifiedEvent {
  string domain_id = 1;
  string tenant_id = 2;
  string domain = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

// ======================================================
// REQUEST / RESPONSE
// ======================================================

message AddDomainRequest {
  string tenant_id = 1;
  string domain = 2;
  DomainVerificationMethod verification_method = 3;
}

message AddDomainResponse {
  Domain domain = 1;
}

message VerifyDomainRequest {
  string domain_id = 1;
}

message VerifyDomainResponse {
  Domain domain = 1;
}

message ListDomainsRequest {
  string tenant_id = 1;
}

message ListDomainsResponse {
  repeated Domain domains = 1;
}

message GetDomainRequest {
  string id = 1;
}

message GetDomainResponse {
  Domain domain = 1;
}

// ======================================================
// DOMAIN SERVICE
// ======================================================

service DomainService {

  rpc AddDomain(AddDomainRequest)
      returns (AddDomainResponse) {
    option (google.api.http) = {
      post: "/v1/domains"
      body: "*"
    };
  }

  rpc VerifyDomain(VerifyDomainRequest)
      returns (VerifyDomainResponse) {
    option (google.api.http) = {
      post: "/v1/domains/{domain_id}:verify"
      body: "*"
    };
  }

  rpc GetDomain(GetDomainRequest)
      returns (GetDomainResponse) {
    option (google.api.http) = {
      get: "/v1/domains/{id}"
    };
  }

  rpc ListDomains(ListDomainsRequest)
      returns (ListDomainsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant_id}/domains"
    };
  }
}
