syntax = "proto3";

package smallbiznis.fulfillment.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/fulfillment/v1;fulfillmentv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum FulfillmentStatus {
  FULFILLMENT_STATUS_UNSPECIFIED = 0;
  FULFILLMENT_PENDING = 1;          // baru dibuat, belum dikerjakan
  FULFILLMENT_IN_PROGRESS = 2;      // sedang disiapkan
  FULFILLMENT_READY_FOR_PICKUP = 3; // siap diambil / dihidangkan
  FULFILLMENT_OUT_FOR_DELIVERY = 4; // sedang diantar
  FULFILLMENT_COMPLETED = 5;        // sudah diterima
  FULFILLMENT_CANCELLED = 6;
}

enum FulfillmentItemStatus {
  FULFILLMENT_ITEM_STATUS_UNSPECIFIED = 0;
  ITEM_PENDING = 1;
  ITEM_IN_PROGRESS = 2;
  ITEM_READY = 3;
  ITEM_CANCELLED = 4;
}

enum FulfillmentType {
  FULFILLMENT_TYPE_UNSPECIFIED = 0;
  FULFILLMENT_DINE_IN = 1;
  FULFILLMENT_TAKE_AWAY = 2;
  FULFILLMENT_DELIVERY = 3;
  FULFILLMENT_PICKUP = 4;
}

enum AssignmentStatus {
  ASSIGNMENT_STATUS_UNSPECIFIED = 0;
  ASSIGNMENT_PENDING = 1;
  ASSIGNMENT_ACCEPTED = 2;
  ASSIGNMENT_IN_TRANSIT = 3;
  ASSIGNMENT_COMPLETED = 4;
  ASSIGNMENT_CANCELLED = 5;
}

// ======================================================
// MODELS
// ======================================================

message FulfillmentOrder {
  string id = 1;          // snowflake as string
  string tenant_id = 2;
  string order_id = 3;    // from TransactionService
  string location_id = 4;

  FulfillmentType type = 5;
  FulfillmentStatus status = 6;

  // kode pickup (untuk ditunjukkan ke kasir / barista)
  string pickup_code = 7;

  google.protobuf.Timestamp estimated_ready_at = 8;
  google.protobuf.Timestamp delivered_at = 9;

  string note = 10;

  google.protobuf.Struct metadata = 11;

  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

message FulfillmentItem {
  string id = 1;
  string fulfillment_id = 2;

  string order_item_id = 3;
  string product_id = 4;
  string variant_id = 5;

  int64 quantity = 6;
  FulfillmentItemStatus status = 7;

  // misal: "BAR", "KITCHEN", "PASTRY"
  string station = 8;

  google.protobuf.Struct metadata = 9;

  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

message FulfillmentAssignment {
  string id = 1;
  string fulfillment_id = 2;

  // bisa user_id internal atau courier_id eksternal
  string assignee_id = 3;

  // "INTERNAL", "GOJEK", "GRAB", "CUSTOM"
  string channel = 4;

  // tracking id dari provider
  string external_ref = 5;

  AssignmentStatus status = 6;

  google.protobuf.Struct metadata = 7;

  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

message FulfillmentEvent {
  string id = 1;
  string fulfillment_id = 2;

  FulfillmentStatus status = 3;
  string note = 4;

  google.protobuf.Struct metadata = 5;

  google.protobuf.Timestamp created_at = 6;
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

// ------ CREATE FULFILLMENT FROM ORDER ------

message CreateFulfillmentRequest {
  string tenant_id = 1;
  string order_id = 2;
  string location_id = 3;

  FulfillmentType type = 4;

  // optional initial note / metadata
  string note = 5;
  google.protobuf.Struct metadata = 6;
}

message CreateFulfillmentResponse {
  FulfillmentOrder fulfillment = 1;
  repeated FulfillmentItem items = 2;
}

// ------ GET / LIST ------

message GetFulfillmentRequest {
  string id = 1;
}

message GetFulfillmentResponse {
  FulfillmentOrder fulfillment = 1;
  repeated FulfillmentItem items = 2;
  repeated FulfillmentAssignment assignments = 3;
}

message ListFulfillmentsRequest {
  string tenant_id = 1;
  string location_id = 2;
  FulfillmentStatus status_filter = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message ListFulfillmentsResponse {
  repeated FulfillmentOrder fulfillments = 1;
  string next_page_token = 2;
}

// ------ UPDATE STATUS (HEADER) ------

message UpdateFulfillmentStatusRequest {
  string id = 1;
  FulfillmentStatus status = 2;
  string note = 3;
}

message UpdateFulfillmentStatusResponse {
  FulfillmentOrder fulfillment = 1;
}

// ------ UPDATE ITEM STATUS (KDS) ------

message UpdateFulfillmentItemStatusRequest {
  string id = 1;
  FulfillmentItemStatus status = 2;
}

message UpdateFulfillmentItemStatusResponse {
  FulfillmentItem item = 1;
}

// ------ ASSIGNMENT (DELIVERY / RUNNER) ------

message AssignFulfillmentRequest {
  string fulfillment_id = 1;

  string assignee_id = 2;
  string channel = 3;
  string external_ref = 4;
  google.protobuf.Struct metadata = 5;
}

message AssignFulfillmentResponse {
  FulfillmentAssignment assignment = 1;
}

message UpdateAssignmentStatusRequest {
  string id = 1;
  AssignmentStatus status = 2;
}

message UpdateAssignmentStatusResponse {
  FulfillmentAssignment assignment = 1;
}

// ======================================================
// SERVICE
// ======================================================

service FulfillmentService {

  // Create fulfillment order when transaction is created
  rpc CreateFulfillment(CreateFulfillmentRequest)
      returns (CreateFulfillmentResponse) {
    option (google.api.http) = {
      post: "/v1/fulfillments"
      body: "*"
    };
  }

  rpc GetFulfillment(GetFulfillmentRequest)
      returns (GetFulfillmentResponse) {
    option (google.api.http) = {
      get: "/v1/fulfillments/{id}"
    };
  }

  rpc ListFulfillments(ListFulfillmentsRequest)
      returns (ListFulfillmentsResponse) {
    option (google.api.http) = {
      get: "/v1/fulfillments"
    };
  }

  rpc UpdateFulfillmentStatus(UpdateFulfillmentStatusRequest)
      returns (UpdateFulfillmentStatusResponse) {
    option (google.api.http) = {
      post: "/v1/fulfillments/{id}:status"
      body: "*"
    };
  }

  rpc UpdateFulfillmentItemStatus(UpdateFulfillmentItemStatusRequest)
      returns (UpdateFulfillmentItemStatusResponse) {
    option (google.api.http) = {
      post: "/v1/fulfillment-items/{id}:status"
      body: "*"
    };
  }

  rpc AssignFulfillment(AssignFulfillmentRequest)
      returns (AssignFulfillmentResponse) {
    option (google.api.http) = {
      post: "/v1/fulfillments/{fulfillment_id}:assign"
      body: "*"
    };
  }

  rpc UpdateAssignmentStatus(UpdateAssignmentStatusRequest)
      returns (UpdateAssignmentStatusResponse) {
    option (google.api.http) = {
      post: "/v1/assignments/{id}:status"
      body: "*"
    };
  }
}
