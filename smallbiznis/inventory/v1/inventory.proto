syntax = "proto3";

package smallbiznis.inventory.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/inventory/v1;inventoryv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum LocationType {
  LOCATION_TYPE_UNSPECIFIED = 0;
  STORE = 1;
  WAREHOUSE = 2;
  KITCHEN = 3;
  PICKUP_POINT = 4;
}

enum MovementType {
  MOVEMENT_TYPE_UNSPECIFIED = 0;
  INBOUND = 1;   // stock bertambah
  OUTBOUND = 2;  // stock berkurang
}

enum AdjustmentReason {
  ADJUSTMENT_REASON_UNSPECIFIED = 0;
  MANUAL_UPDATE = 1;
  DAMAGED = 2;
  LOST = 3;
  RETURNED = 4;
  INITIAL_STOCK = 5;
}

// ======================================================
// MODELS
// ======================================================

message Location {
  string id = 1;
  string tenant_id = 2;

  string name = 3;
  string code = 4;
  LocationType type = 5;

  bool active = 6;

  google.protobuf.Struct metadata = 7;

  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

message Inventory {
  string id = 1;
  string tenant_id = 2;
  string location_id = 3;
  string variant_id = 4;

  int64 quantity_on_hand = 5;
  int64 min_stock_level = 6;
  int64 reorder_point = 7;

  google.protobuf.Timestamp updated_at = 8;
}

message InventoryMovement {
  string id = 1;
  string tenant_id = 2;
  string location_id = 3;
  string variant_id = 4;

  MovementType movement_type = 5;
  int64 quantity = 6;

  string reference = 7;     // e.g. order_id / adjustment_id
  string note = 8;

  google.protobuf.Struct metadata = 9;

  google.protobuf.Timestamp created_at = 10;
}

message StockAdjustment {
  string id = 1;
  string tenant_id = 2;
  string location_id = 3;
  string variant_id = 4;

  int64 quantity_before = 5;
  int64 quantity_after = 6;

  AdjustmentReason reason = 7;
  string note = 8;

  google.protobuf.Timestamp created_at = 9;
}

// ======================================================
// EVENTS
// ======================================================

message InventoryLowEvent {
  string tenant_id = 1;
  string variant_id = 2;
  string location_id = 3;
  int64 quantity_on_hand = 4;
  google.protobuf.Timestamp occurred_at = 5;
}

message InventoryMovementEvent {
  string movement_id = 1;
  string tenant_id = 2;
  string variant_id = 3;
  int64 quantity = 4;
  MovementType movement_type = 5;
  google.protobuf.Timestamp occurred_at = 6;
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

// -------- LOCATION --------

message CreateLocationRequest {
  string tenant_id = 1;
  string name = 2;
  string code = 3;
  LocationType type = 4;
  google.protobuf.Struct metadata = 5;
}

message CreateLocationResponse {
  Location location = 1;
}

message ListLocationsRequest {
  string tenant_id = 1;
}

message ListLocationsResponse {
  repeated Location locations = 1;
}

// -------- INVENTORY --------

message GetInventoryRequest {
  string variant_id = 1;
  string location_id = 2;
}

message GetInventoryResponse {
  Inventory inventory = 1;
}

message ListInventoryByLocationRequest {
  string location_id = 1;
}

message ListInventoryByLocationResponse {
  repeated Inventory inventory = 1;
}

message AdjustStockRequest {
  string tenant_id = 1;
  string location_id = 2;
  string variant_id = 3;

  int64 new_quantity = 4;
  AdjustmentReason reason = 5;
  string note = 6;
}

message AdjustStockResponse {
  StockAdjustment adjustment = 1;
}

// -------- MOVEMENTS --------

message RecordMovementRequest {
  string tenant_id = 1;
  string location_id = 2;
  string variant_id = 3;

  MovementType movement_type = 4;
  int64 quantity = 5;

  string reference = 6;
  string note = 7;
  google.protobuf.Struct metadata = 8;
}

message RecordMovementResponse {
  InventoryMovement movement = 1;
}

message ListMovementsRequest {
  string variant_id = 1;
  string location_id = 2;
}

message ListMovementsResponse {
  repeated InventoryMovement movements = 1;
}

// ======================================================
// SERVICE
// ======================================================

service InventoryService {

  // -------- Locations --------

  rpc CreateLocation(CreateLocationRequest)
      returns (CreateLocationResponse) {
    option (google.api.http) = {
      post: "/v1/locations"
      body: "*"
    };
  }

  rpc ListLocations(ListLocationsRequest)
      returns (ListLocationsResponse) {
    option (google.api.http) = {
      get: "/v1/locations"
    };
  }

  // -------- Inventory --------

  rpc GetInventory(GetInventoryRequest)
      returns (GetInventoryResponse) {
    option (google.api.http) = {
      get: "/v1/inventory"
    };
  }

  rpc ListInventoryByLocation(ListInventoryByLocationRequest)
      returns (ListInventoryByLocationResponse) {
    option (google.api.http) = {
      get: "/v1/locations/{location_id}/inventory"
    };
  }

  rpc AdjustStock(AdjustStockRequest)
      returns (AdjustStockResponse) {
    option (google.api.http) = {
      post: "/v1/inventory:adjust"
      body: "*"
    };
  }

  // -------- Movements --------

  rpc RecordMovement(RecordMovementRequest)
      returns (RecordMovementResponse) {
    option (google.api.http) = {
      post: "/v1/inventory/movements"
      body: "*"
    };
  }

  rpc ListMovements(ListMovementsRequest)
      returns (ListMovementsResponse) {
    option (google.api.http) = {
      get: "/v1/inventory/movements"
    };
  }
}
