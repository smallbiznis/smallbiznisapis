syntax = "proto3";

package smallbiznis.invoice.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/invoice/v1;invoicev1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";

// =======================
// Enums
// =======================

enum InvoiceStatus {
  INVOICE_STATUS_UNSPECIFIED = 0;
  DRAFT = 1;
  OPEN = 2;
  PAID = 3;
  VOID = 4;
  UNCOLLECTIBLE = 5;
}

enum InvoiceLineType {
  INVOICE_LINE_TYPE_UNSPECIFIED = 0;
  RECURRING = 1;
  USAGE = 2;
  DISCOUNT = 3;
  TAX = 4;
  ADJUSTMENT = 5;
}

// =======================
// Invoice
// =======================

message Invoice {
  string id = 1;
  string tenant_id = 2;
  string customer_id = 3;
  string subscription_id = 4;

  InvoiceStatus status = 5;

  string currency_code = 6;

  int64 subtotal_cents = 7;
  int64 tax_cents = 8;
  int64 discount_cents = 9;
  int64 total_cents = 10;

  string invoice_number = 11;
  int64 sequence_number = 12;

  google.protobuf.Timestamp issued_at = 13;
  google.protobuf.Timestamp due_at = 14;
  google.protobuf.Timestamp paid_at = 15;

  google.protobuf.Struct metadata = 16;

  google.protobuf.Timestamp created_at = 17;
  google.protobuf.Timestamp updated_at = 18;
}

// =======================
// Invoice Items (IMMUTABLE)
// =======================

message InvoiceItem {
  string id = 1;
  string invoice_id = 2;
  string tenant_id = 3;

  string subscription_item_id = 4;
  string meter_id = 5;
  string meter_code = 6;

  string price_id = 7;
  string price_code = 8;

  InvoiceLineType line_type = 9;

  double quantity = 10;

  // FINAL SNAPSHOT
  int64 unit_amount_cents = 11;
  int64 subtotal_cents = 12;
  int64 tax_amount_cents = 13;
  int64 discount_amount_cents = 14;
  int64 total_cents = 15;

  google.protobuf.Timestamp period_start = 16;
  google.protobuf.Timestamp period_end = 17;

  google.protobuf.Struct metadata = 18;

  google.protobuf.Timestamp created_at = 19;
}

// =======================
// Read APIs
// =======================

message GetInvoiceRequest {
  string tenant_id = 1;
  string id = 2;
}

message ListInvoicesRequest {
  string tenant_id = 1;
  string customer_id = 2;
  int32 page_size = 3;
  string page_token = 4;
}

message ListInvoicesResponse {
  repeated Invoice invoices = 1;
  string next_page_token = 2;
}

message ListInvoiceItemsRequest {
  string tenant_id = 1;
  string invoice_id = 2;
}

message ListInvoiceItemsResponse {
  repeated InvoiceItem invoice_items = 1;
  string next_page_token = 2;
}


service InvoiceService {

  rpc GetInvoice(GetInvoiceRequest)
    returns (Invoice) {
      option (google.api.http) = {
        get: "/v1/invoices/{id}"
      };
    }

  rpc ListInvoices(ListInvoicesRequest)
      returns (ListInvoicesResponse) {
        option (google.api.http) = {
          get: "/v1/invoices"
        };
      };

  rpc ListInvoiceItems(ListInvoiceItemsRequest)
      returns (ListInvoiceItemsResponse) {
        option (google.api.http) = {
          get: "/v1/invoices/{invoice_id}/invoice_items"
        };
      };
}