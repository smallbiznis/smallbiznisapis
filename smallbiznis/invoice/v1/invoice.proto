syntax = "proto3";

package smallbiznis.billing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/billing/v1;billingv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum InvoiceStatus {
  INVOICE_STATUS_UNSPECIFIED = 0;
  DRAFT = 1;
  OPEN = 2;         // awaiting payment
  PAID = 3;
  VOID = 4;
  REFUNDED = 5;
  PARTIALLY_PAID = 6;
  PARTIALLY_REFUNDED = 7;
}

enum LineItemType {
  LINE_ITEM_TYPE_UNSPECIFIED = 0;
  SUBSCRIPTION = 1;
  USAGE = 2;
  ONE_TIME = 3;
  DISCOUNT = 4;
  TAX = 5;
  ADJUSTMENT = 6;
}

// ======================================================
// MODELS
// ======================================================

// ---------- INVOICE ----------

message Invoice {
  string id = 1;
  string tenant_id = 2;

  string invoice_number = 3;  // human readable: INV-2025-00001

  InvoiceStatus status = 4;

  int64 subtotal_cents = 5;
  int64 tax_cents = 6;
  int64 total_cents = 7;
  int64 amount_due_cents = 8;
  int64 amount_paid_cents = 9;

  google.protobuf.Timestamp issued_at = 10;
  google.protobuf.Timestamp due_at = 11;
  google.protobuf.Timestamp paid_at = 12;

  google.protobuf.Struct metadata = 13;

  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
}

// ---------- LINE ITEM ----------

message InvoiceLineItem {
  string id = 1;
  string invoice_id = 2;

  LineItemType type = 3;

  string title = 4;
  string description = 5;

  int64 quantity = 6;
  int64 unit_price_cents = 7;
  int64 amount_cents = 8;

  string reference_id = 9;     // subscription.id / usage_record.id
  string reference_type = 10;  // "SUBSCRIPTION", "USAGE"

  google.protobuf.Struct metadata = 11;
  google.protobuf.Timestamp created_at = 12;
}

// ---------- PAYMENT RECORD ----------

message InvoicePayment {
  string id = 1;
  string invoice_id = 2;

  int64 amount_cents = 3;

  string method = 4;       // "BALANCE", "MANUAL", "PAYMENT_GATEWAY"
  string reference_id = 5; // ledger entry ID or gateway transaction_id

  google.protobuf.Timestamp paid_at = 6;
  google.protobuf.Struct metadata = 7;
}

// ======================================================
// REQUESTS & RESPONSES
// ======================================================

// ---------- CREATE INVOICE ----------

message CreateInvoiceRequest {
  string tenant_id = 1;

  // invoice metadata
  google.protobuf.Timestamp due_at = 2;
  google.protobuf.Struct metadata = 3;

  // initial line items (optional)
  repeated InvoiceLineItem items = 4;
}

message CreateInvoiceResponse {
  Invoice invoice = 1;
}

// ---------- ADD LINE ITEM ----------

message AddLineItemRequest {
  string invoice_id = 1;
  LineItemType type = 2;
  string title = 3;
  string description = 4;
  int64 quantity = 5;
  int64 unit_price_cents = 6;

  string reference_id = 7;
  string reference_type = 8;

  google.protobuf.Struct metadata = 9;
}

message AddLineItemResponse {
  InvoiceLineItem item = 1;
}

// ---------- GET INVOICE ----------

message GetInvoiceRequest {
  string id = 1;
}

message GetInvoiceResponse {
  Invoice invoice = 1;
  repeated InvoiceLineItem items = 2;
  repeated InvoicePayment payments = 3;
}

// ---------- LIST INVOICES ----------

message ListInvoicesRequest {
  string tenant_id = 1;
  InvoiceStatus status_filter = 2;
}

message ListInvoicesResponse {
  repeated Invoice invoices = 1;
}

// ---------- PAYMENT (manual / ledger) ----------

message RecordInvoicePaymentRequest {
  string invoice_id = 1;
  int64 amount_cents = 2;

  string method = 3;       // "BALANCE", "MANUAL"
  string reference_id = 4;

  google.protobuf.Struct metadata = 5;
}

message RecordInvoicePaymentResponse {
  Invoice invoice = 1;
  InvoicePayment payment = 2;
}

// ---------- VOID / REFUND ----------

message VoidInvoiceRequest {
  string invoice_id = 1;
}

message VoidInvoiceResponse {
  Invoice invoice = 1;
}

message RefundInvoiceRequest {
  string invoice_id = 1;
  int64 amount_cents = 2;  // optional partial refund
  google.protobuf.Struct metadata = 3;
}

message RefundInvoiceResponse {
  Invoice invoice = 1;
}

// ======================================================
// SERVICE
// ======================================================

service InvoiceService {

  rpc CreateInvoice(CreateInvoiceRequest)
      returns (CreateInvoiceResponse) {
    option (google.api.http) = {
      post: "/v1/invoices"
      body: "*"
    };
  }

  rpc AddLineItem(AddLineItemRequest)
      returns (AddLineItemResponse) {
    option (google.api.http) = {
      post: "/v1/invoices/{invoice_id}/items"
      body: "*"
    };
  }

  rpc GetInvoice(GetInvoiceRequest)
      returns (GetInvoiceResponse) {
    option (google.api.http) = {
      get: "/v1/invoices/{id}"
    };
  }

  rpc ListInvoices(ListInvoicesRequest)
      returns (ListInvoicesResponse) {
    option (google.api.http) = {
      get: "/v1/invoices"
    };
  }

  rpc RecordInvoicePayment(RecordInvoicePaymentRequest)
      returns (RecordInvoicePaymentResponse) {
    option (google.api.http) = {
      post: "/v1/invoices/{invoice_id}/payments"
      body: "*"
    };
  }

  rpc VoidInvoice(VoidInvoiceRequest)
      returns (VoidInvoiceResponse) {
    option (google.api.http) = {
      post: "/v1/invoices/{invoice_id}:void"
      body: "*"
    };
  }

  rpc RefundInvoice(RefundInvoiceRequest)
      returns (RefundInvoiceResponse) {
    option (google.api.http) = {
      post: "/v1/invoices/{invoice_id}:refund"
      body: "*"
    };
  }
}
