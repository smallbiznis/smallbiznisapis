syntax = "proto3";

package smallbiznis.invoice.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/invoice/v1;invoicev1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/api/annotations.proto";

import "smallbiznis/common/money.proto";

// ============================================
// Enums & Common
// ============================================

enum InvoiceStatus {
  INVOICE_STATUS_UNSPECIFIED = 0;
  INVOICE_STATUS_DRAFT       = 1;
  INVOICE_STATUS_PENDING     = 2;
  INVOICE_STATUS_PAID        = 3;
  INVOICE_STATUS_OVERDUE     = 4;
  INVOICE_STATUS_VOID        = 5;
  INVOICE_STATUS_REFUNDED    = 6;
}

enum InvoiceLineItemType {
  LINE_ITEM_TYPE_UNSPECIFIED = 0;
  LINE_ITEM_TYPE_RECURRING   = 1;
  LINE_ITEM_TYPE_USAGE       = 2;
  LINE_ITEM_TYPE_OVERAGE     = 3;
  LINE_ITEM_TYPE_DISCOUNT    = 4;
  LINE_ITEM_TYPE_TAX         = 5;
  LINE_ITEM_TYPE_ADJUSTMENT  = 6;
}

// ============================================
// Models
// ============================================

message InvoiceLineItem {
  string                id            = 1;
  InvoiceLineItemType   type          = 2;
  string                description   = 3;
  int64                 quantity      = 4;
  smallbiznis.common.Money                 unit_price    = 5;
  smallbiznis.common.Money                 amount        = 6;
  string                metric_code   = 7;  // e.g. "api_calls"
  google.protobuf.Struct metadata     = 8;
}

message TaxBreakdown {
  string name          = 1;   // e.g. "PPN"
  double rate_percent  = 2;   // e.g. 11.0
  smallbiznis.common.Money  amount        = 3;
}

message Invoice {
  string                           id                  = 1;
  string                           tenant_id           = 2;
  string                           subscription_id     = 3;
  string                           invoice_number      = 4;
  InvoiceStatus                    status              = 5;

  google.protobuf.Timestamp        billing_period_start = 10;
  google.protobuf.Timestamp        billing_period_end   = 11;
  google.protobuf.Timestamp        issued_at            = 12;
  google.protobuf.Timestamp        due_at               = 13;
  google.protobuf.Timestamp        paid_at              = 14;
  google.protobuf.Timestamp        void_at              = 15;

  repeated InvoiceLineItem         line_items          = 20;
  smallbiznis.common.Money                            subtotal            = 21;
  smallbiznis.common.Money                            discount_total      = 22;
  smallbiznis.common.Money                            tax_total           = 23;
  smallbiznis.common.Money                            total               = 24;
  smallbiznis.common.Money                            amount_paid         = 25;
  smallbiznis.common.Money                            amount_due          = 26;

  repeated TaxBreakdown            taxes               = 30;

  string                           currency_code       = 40;
  string                           customer_reference  = 41;

  google.protobuf.Struct           metadata            = 90;

  google.protobuf.Timestamp        created_at          = 100;
  google.protobuf.Timestamp        updated_at          = 101;
}

// ============================================
// Requests / Responses
// ============================================

message GetInvoiceRequest {
  string id = 1;
}

message ListInvoicesRequest {
  string tenant_id     = 1;
  string subscription_id = 2;
  int32  page_size     = 10;
  string page_token    = 11;
  InvoiceStatus status = 12;
}

message ListInvoicesResponse {
  repeated Invoice invoices   = 1;
  string          next_page_token = 2;
}

message GenerateInvoiceForSubscriptionRequest {
  string subscription_id = 1;
  // Jika diisi, override billing period
  google.protobuf.Timestamp billing_period_start = 2;
  google.protobuf.Timestamp billing_period_end   = 3;
  bool   dry_run = 4; // jika true, hanya preview, tidak persist
}

message GenerateInvoiceResponse {
  Invoice invoice = 1;
}

message GetInvoicePdfRequest {
  string id = 1;
}

message GetInvoicePdfResponse {
  // Bisa signed URL atau path internal
  string pdf_url = 1;
}

// ============================================
// Service
// ============================================

service InvoiceService {

  rpc GetInvoice(GetInvoiceRequest) returns (Invoice) {
    option (google.api.http) = {
      get: "/v1/billing/invoices/{id}"
    };
  }

  rpc ListInvoices(ListInvoicesRequest) returns (ListInvoicesResponse) {
    option (google.api.http) = {
      get: "/v1/billing/invoices"
    };
  }

  // Dipanggil oleh scheduler / subscription renewal
  rpc GenerateInvoiceForSubscription(GenerateInvoiceForSubscriptionRequest)
      returns (GenerateInvoiceResponse) {
    option (google.api.http) = {
      post: "/v1/billing/subscriptions/{subscription_id}/generate-invoice"
      body: "*"
    };
  }

  rpc GetInvoicePdf(GetInvoicePdfRequest) returns (GetInvoicePdfResponse) {
    option (google.api.http) = {
      get: "/v1/billing/invoices/{id}/pdf"
    };
  }
}
