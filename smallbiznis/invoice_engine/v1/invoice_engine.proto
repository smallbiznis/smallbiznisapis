syntax = "proto3";

package smallbiznis.invoice_engine.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/invoice_engine/v1;invoiceenginev1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "smallbiznis/common/money.proto";

// ============================================================
// ENUMS
// ============================================================

enum ProrationType {
  PRORATION_TYPE_UNSPECIFIED = 0;
  PRORATION_TYPE_UPGRADE     = 1;
  PRORATION_TYPE_DOWNGRADE   = 2;
  PRORATION_TYPE_CANCEL      = 3;
}

// Billing period transition status
enum BillingPeriodStatus {
  BILLING_PERIOD_STATUS_UNSPECIFIED = 0;
  BILLING_PERIOD_STATUS_OPEN        = 1;
  BILLING_PERIOD_STATUS_CLOSED      = 2;
  BILLING_PERIOD_STATUS_INVOICED    = 3;
}

// ============================================================
// COMMON MODELS
// ============================================================

// A single computed charge component (usage/recurring/proration/etc)
message ChargeComponent {
  string id = 1;
  string description = 2;
  int64 quantity = 3;
  smallbiznis.common.Money unit_price = 4;
  smallbiznis.common.Money amount = 5;

  // type: recurring, usage, tax, discount, adjustment, overage
  string type = 6;

  string metric_code = 7;
  google.protobuf.Struct metadata = 20;
}

// Result after applying taxes
message TaxResult {
  repeated ChargeComponent taxes = 1;
  smallbiznis.common.Money total_tax = 2;
}

// Result after applying discounts
message DiscountResult {
  repeated ChargeComponent discounts = 1;
  smallbiznis.common.Money total_discount = 2;
}

// Result after applying credits
message CreditResult {
  smallbiznis.common.Money credit_used = 1;
  smallbiznis.common.Money credit_remaining = 2;
}

// ============================================================
// INVOICE BUILD & COMPUTATION
// ============================================================

// Build all line items for the invoice (usage + recurring + proration)
message BuildInvoiceRequest {
  string tenant_id = 1;
  string subscription_id = 2;

  google.protobuf.Timestamp billing_period_start = 3;
  google.protobuf.Timestamp billing_period_end = 4;

  bool dry_run = 10; // do not persist
}

message BuildInvoiceResponse {
  repeated ChargeComponent line_items = 1;

  smallbiznis.common.Money subtotal = 10;
  smallbiznis.common.Money discount_total = 11;
  smallbiznis.common.Money tax_total = 12;
  smallbiznis.common.Money total = 13;

  google.protobuf.Struct metadata = 20;
}

// ============================================================
// PRORATION / UPGRADES / DOWNGRADES
// ============================================================

message ProrationRequest {
  string tenant_id = 1;
  string subscription_id = 2;

  ProrationType proration_type = 3;

  google.protobuf.Timestamp from_time = 10;
  google.protobuf.Timestamp to_time = 11;

  smallbiznis.common.Money old_amount = 20;
  smallbiznis.common.Money new_amount = 21;

  google.protobuf.Struct metadata = 30;
}

message ProrationResponse {
  repeated ChargeComponent proration_items = 1;
  smallbiznis.common.Money total_proration_amount = 2;
}

// ============================================================
// TAX COMPUTATION
// ============================================================

message ApplyTaxRequest {
  string tenant_id = 1;

  repeated ChargeComponent line_items = 2;

  // Optional: region code, tax_profile_id, etc.
  string tax_profile = 3;
}

message ApplyTaxResponse {
  repeated ChargeComponent taxes = 1;
  smallbiznis.common.Money total_tax = 2;
}

// ============================================================
// DISCOUNT COMPUTATION
// ============================================================

message ApplyDiscountRequest {
  string tenant_id = 1;
  repeated ChargeComponent line_items = 2;
}

message ApplyDiscountResponse {
  repeated ChargeComponent discounts = 1;
  smallbiznis.common.Money total_discount = 2;
}

// ============================================================
// CREDIT (BALANCE) APPLICATION
// ============================================================

message ApplyCreditRequest {
  string tenant_id = 1;
  smallbiznis.common.Money invoice_total = 2;
}

message ApplyCreditResponse {
  smallbiznis.common.Money credit_used = 1;
  smallbiznis.common.Money credit_remaining = 2;
  smallbiznis.common.Money amount_due_after_credit = 3;
}

// ============================================================
// FINALIZATION
// ============================================================

message FinalizeInvoiceRequest {
  string tenant_id = 1;
  string subscription_id = 2;

  repeated ChargeComponent line_items = 10;
  repeated ChargeComponent taxes = 11;
  repeated ChargeComponent discounts = 12;

  smallbiznis.common.Money subtotal = 20;
  smallbiznis.common.Money discount_total = 21;
  smallbiznis.common.Money tax_total = 22;
  smallbiznis.common.Money total = 23;

  google.protobuf.Timestamp billing_period_start = 30;
  google.protobuf.Timestamp billing_period_end = 31;

  bool generate_invoice_number = 40;
}

message FinalizeInvoiceResponse {
  string invoice_id = 1;
  string invoice_number = 2;

  smallbiznis.common.Money total = 10;
  smallbiznis.common.Money amount_due = 11;

  google.protobuf.Timestamp issued_at = 20;
}

// ============================================================
// BILLING PERIOD MANAGEMENT
// ============================================================

message OpenBillingPeriodRequest {
  string tenant_id = 1;
  google.protobuf.Timestamp period_start = 2;
}

message OpenBillingPeriodResponse {
  string period_id = 1;
  BillingPeriodStatus status = 2;
}

message CloseBillingPeriodRequest {
  string tenant_id = 1;
  string period_id = 2;
  google.protobuf.Timestamp closed_at = 3;
}

message CloseBillingPeriodResponse {
  BillingPeriodStatus status = 1;
}

// ============================================================
// INVOICE NUMBERING
// ============================================================

message GenerateInvoiceNumberRequest {
  string tenant_id = 1;
}

message GenerateInvoiceNumberResponse {
  string invoice_number = 1;
}

// ============================================================
// SERVICE DEFINITION
// ============================================================

service InvoiceEngineService {

  // Build line items + total (dry-run or real)
  rpc BuildInvoice(BuildInvoiceRequest) returns (BuildInvoiceResponse);

  // Internal proration pipeline
  rpc RunProration(ProrationRequest) returns (ProrationResponse);

  // Tax engine
  rpc ApplyTax(ApplyTaxRequest) returns (ApplyTaxResponse);

  // Discount engine
  rpc ApplyDiscount(ApplyDiscountRequest) returns (ApplyDiscountResponse);

  // Credit deduction
  rpc ApplyCredit(ApplyCreditRequest) returns (ApplyCreditResponse);

  // Finalize and persist invoice
  rpc FinalizeInvoice(FinalizeInvoiceRequest) returns (FinalizeInvoiceResponse);

  // Billing period control
  rpc OpenBillingPeriod(OpenBillingPeriodRequest) returns (OpenBillingPeriodResponse);
  rpc CloseBillingPeriod(CloseBillingPeriodRequest) returns (CloseBillingPeriodResponse);

  // Generate invoice number (sequence)
  rpc GenerateInvoiceNumber(GenerateInvoiceNumberRequest) returns (GenerateInvoiceNumberResponse);
}
