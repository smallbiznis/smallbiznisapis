syntax = "proto3";

package smallbiznis.notification.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/notification/v1;notificationv1";

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum Channel {
  CHANNEL_UNSPECIFIED = 0;
  EMAIL = 1;
  WHATSAPP = 2;
  SMS = 3;
  PUSH = 4;
  INAPP = 5;             // Inbox message
  WEBHOOK = 6;
}

enum NotificationStatus {
  NOTIFICATION_STATUS_UNSPECIFIED = 0;
  QUEUED = 1;
  SENT = 2;
  FAILED = 3;
  DELIVERED = 4;
}

enum AttemptStatus {
  ATTEMPT_STATUS_UNSPECIFIED = 0;
  ATTEMPT_SUCCESS = 1;
  ATTEMPT_FAILED = 2;
}

// ======================================================
// MODELS
// ======================================================

// -------- TEMPLATE --------

message NotificationTemplate {
  string id = 1 [(google.api.field_behavior) = REQUIRED,
                 (google.api.field_behavior) = IMMUTABLE];
  string tenant_id = 2 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];

  string name = 3 [(google.api.field_behavior) = REQUIRED];
  Channel channel = 4 [(google.api.field_behavior) = REQUIRED];

  string subject = 5 [(google.api.field_behavior) = REQUIRED];     // email only
  string body = 6 [(google.api.field_behavior) = REQUIRED];        // html/text template

  google.protobuf.Struct metadata = 7;

  google.protobuf.Timestamp created_at = 8 [(google.api.field_behavior) = OUTPUT_ONLY];
  google.protobuf.Timestamp updated_at = 9 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// -------- MESSAGE --------

message NotificationMessage {
  string id = 1 [(google.api.field_behavior) = REQUIRED,
                 (google.api.field_behavior) = IMMUTABLE];
  string tenant_id = 2 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];

  Channel channel = 3 [(google.api.field_behavior) = REQUIRED];

  string template_id = 4 [(google.api.field_behavior) = REQUIRED];

  string recipient = 5 [(google.api.field_behavior) = REQUIRED];        // email/phone/token/user_id
  string subject = 6 [(google.api.field_behavior) = REQUIRED];
  string body = 7 [(google.api.field_behavior) = REQUIRED];

  NotificationStatus status = 8 [(google.api.field_behavior) = REQUIRED];

  google.protobuf.Struct variables = 9; // original vars before render
  google.protobuf.Struct metadata = 10;

  google.protobuf.Timestamp created_at = 11 [(google.api.field_behavior) = OUTPUT_ONLY];
  google.protobuf.Timestamp updated_at = 12 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// -------- DELIVERY ATTEMPT --------

message DeliveryAttempt {
  string id = 1 [(google.api.field_behavior) = REQUIRED,
                 (google.api.field_behavior) = IMMUTABLE];
  string message_id = 2 [(google.api.field_behavior) = REQUIRED,
                         (google.api.field_behavior) = IMMUTABLE];

  AttemptStatus status = 3 [(google.api.field_behavior) = REQUIRED];
  string provider_response = 4;
  google.protobuf.Timestamp created_at = 5 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// -------- PROVIDER CONFIG --------

message ChannelProviderConfig {
  string id = 1 [(google.api.field_behavior) = REQUIRED,
                 (google.api.field_behavior) = IMMUTABLE];
  string tenant_id = 2 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];

  Channel channel = 3 [(google.api.field_behavior) = REQUIRED];

  google.protobuf.Struct config = 4; // smtp creds, whatsapp api key, FCM key, etc.

  google.protobuf.Timestamp created_at = 5 [(google.api.field_behavior) = OUTPUT_ONLY];
  google.protobuf.Timestamp updated_at = 6 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

// ------- TEMPLATE CRUD -------

message CreateTemplateRequest {
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];
  string name = 2 [(google.api.field_behavior) = REQUIRED];
  Channel channel = 3 [(google.api.field_behavior) = REQUIRED];
  string subject = 4 [(google.api.field_behavior) = REQUIRED];
  string body = 5 [(google.api.field_behavior) = REQUIRED];
  google.protobuf.Struct metadata = 6;
}

message CreateTemplateResponse {
  NotificationTemplate template = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message ListTemplatesRequest {
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];
}

message ListTemplatesResponse {
  repeated NotificationTemplate templates = 1;
}

// ------- SEND MESSAGE -------

message SendNotificationRequest {
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];

  Channel channel = 2 [(google.api.field_behavior) = REQUIRED];

  string template_id = 3 [(google.api.field_behavior) = REQUIRED];
  string recipient = 4 [(google.api.field_behavior) = REQUIRED];

  google.protobuf.Struct variables = 5;   // to render template
  google.protobuf.Struct metadata = 6;
}

message SendNotificationResponse {
  NotificationMessage message = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ------- GET MESSAGE -------

message GetNotificationRequest {
  string id = 1 [(google.api.field_behavior) = REQUIRED,
                 (google.api.field_behavior) = IMMUTABLE];
}

message GetNotificationResponse {
  NotificationMessage message = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  repeated DeliveryAttempt attempts = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ------- PROVIDER CONFIG -------

message SetChannelConfigRequest {
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];
  Channel channel = 2 [(google.api.field_behavior) = REQUIRED];
  google.protobuf.Struct config = 3 [(google.api.field_behavior) = REQUIRED];
}

message SetChannelConfigResponse {
  ChannelProviderConfig config = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message GetChannelConfigRequest {
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];
  Channel channel = 2 [(google.api.field_behavior) = REQUIRED];
}

message GetChannelConfigResponse {
  ChannelProviderConfig config = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ======================================================
// SERVICE
// ======================================================

service NotificationService {

  // Templates
  rpc CreateTemplate(CreateTemplateRequest)
      returns (CreateTemplateResponse) {
    option (google.api.http) = {
      post: "/v1/notifications/templates"
      body: "*"
    };
  }

  rpc ListTemplates(ListTemplatesRequest)
      returns (ListTemplatesResponse) {
    option (google.api.http) = {
      get: "/v1/notifications/templates"
    };
  }

  // Sending
  rpc SendNotification(SendNotificationRequest)
      returns (SendNotificationResponse) {
    option (google.api.http) = {
      post: "/v1/notifications/send"
      body: "*"
    };
  }

  // Message detail + attempts
  rpc GetNotification(GetNotificationRequest)
      returns (GetNotificationResponse) {
    option (google.api.http) = {
      get: "/v1/notifications/{id}"
    };
  }

  // Provider config
  rpc SetChannelConfig(SetChannelConfigRequest)
      returns (SetChannelConfigResponse) {
    option (google.api.http) = {
      post: "/v1/notifications/config"
      body: "*"
    };
  }

  rpc GetChannelConfig(GetChannelConfigRequest)
      returns (GetChannelConfigResponse) {
    option (google.api.http) = {
      get: "/v1/notifications/config"
    };
  }
}
