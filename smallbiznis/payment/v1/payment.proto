syntax = "proto3";

package smallbiznis.payment.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/payment/v1;paymentv1";

import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/struct.proto";

enum PaymentProvider {
  PAYMENT_PROVIDER_UNSPECIFIED = 0;
  PAYMENT_PROVIDER_STRIPE      = 1;
  PAYMENT_PROVIDER_XENDIT      = 2;
  PAYMENT_PROVIDER_MIDTRANS    = 3;
  PAYMENT_PROVIDER_DUMMY       = 9;
}

enum PaymentMethodType {
  PAYMENT_METHOD_TYPE_UNSPECIFIED = 0;
  PAYMENT_METHOD_TYPE_CARD        = 1;
  PAYMENT_METHOD_TYPE_VA          = 2;
  PAYMENT_METHOD_TYPE_EWALLET     = 3;
}

enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_STATUS_PENDING     = 1;
  PAYMENT_STATUS_PROCESSING  = 2;
  PAYMENT_STATUS_SUCCEEDED   = 3;
  PAYMENT_STATUS_FAILED      = 4;
  PAYMENT_STATUS_REFUNDED    = 5;
}

message PaymentMethod {
  string              id             = 1 [(google.api.field_behavior) = REQUIRED,
                                           (google.api.field_behavior) = IMMUTABLE];
  string              tenant_id      = 2 [(google.api.field_behavior) = REQUIRED,
                                           (google.api.field_behavior) = IMMUTABLE];
  PaymentProvider     provider       = 3 [(google.api.field_behavior) = REQUIRED];
  PaymentMethodType   type           = 4 [(google.api.field_behavior) = REQUIRED];
  string              display_name   = 5 [(google.api.field_behavior) = REQUIRED];
  string              last4          = 6;
  string              exp_month      = 7;
  string              exp_year       = 8;
  bool                is_default     = 9;
  google.protobuf.Struct provider_data = 20;
  google.protobuf.Timestamp created_at = 30 [(google.api.field_behavior) = OUTPUT_ONLY];
  google.protobuf.Timestamp updated_at = 31 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message PaymentAttempt {
  string                     id           = 1 [(google.api.field_behavior) = REQUIRED,
                                               (google.api.field_behavior) = IMMUTABLE];
  string                     tenant_id    = 2 [(google.api.field_behavior) = REQUIRED,
                                               (google.api.field_behavior) = IMMUTABLE];
  string                     invoice_id   = 3 [(google.api.field_behavior) = REQUIRED];
  string                     payment_method_id = 4 [(google.api.field_behavior) = REQUIRED];
  PaymentStatus              status       = 5 [(google.api.field_behavior) = REQUIRED];
  string                     provider_transaction_id = 6;
  google.protobuf.Timestamp  attempted_at = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
  google.protobuf.Struct     metadata     = 8;
}

message ListPaymentMethodsRequest {
  string tenant_id = 1 [(google.api.field_behavior) = REQUIRED,
                        (google.api.field_behavior) = IMMUTABLE];
}

message ListPaymentMethodsResponse {
  repeated PaymentMethod methods = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message AttachPaymentMethodRequest {
  string              tenant_id     = 1 [(google.api.field_behavior) = REQUIRED,
                                         (google.api.field_behavior) = IMMUTABLE];
  PaymentProvider     provider      = 2 [(google.api.field_behavior) = REQUIRED];
  PaymentMethodType   type          = 3 [(google.api.field_behavior) = REQUIRED];
  google.protobuf.Struct provider_payload = 4 [(google.api.field_behavior) = REQUIRED];
  bool                set_as_default = 5;
}

message AttachPaymentMethodResponse {
  PaymentMethod method = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message ChargeInvoiceRequest {
  string invoice_id          = 1 [(google.api.field_behavior) = REQUIRED,
                                   (google.api.field_behavior) = IMMUTABLE];
  string payment_method_id   = 2 [(google.api.field_behavior) = REQUIRED,
                                   (google.api.field_behavior) = IMMUTABLE];
}

message ChargeInvoiceResponse {
  PaymentAttempt attempt = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message GetPaymentAttemptsRequest {
  string invoice_id = 1 [(google.api.field_behavior) = REQUIRED,
                          (google.api.field_behavior) = IMMUTABLE];
}

message GetPaymentAttemptsResponse {
  repeated PaymentAttempt attempts = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

service PaymentService {

  rpc ListPaymentMethods(ListPaymentMethodsRequest) returns (ListPaymentMethodsResponse) {
    option (google.api.http) = {
      get: "/v1/billing/tenants/{tenant_id}/payment-methods"
    };
  }

  rpc AttachPaymentMethod(AttachPaymentMethodRequest) returns (AttachPaymentMethodResponse) {
    option (google.api.http) = {
      post: "/v1/billing/tenants/{tenant_id}/payment-methods"
      body: "*"
    };
  }

  rpc ChargeInvoice(ChargeInvoiceRequest) returns (ChargeInvoiceResponse) {
    option (google.api.http) = {
      post: "/v1/billing/invoices/{invoice_id}:charge"
      body: "*"
    };
  }

  rpc GetPaymentAttempts(GetPaymentAttemptsRequest) returns (GetPaymentAttemptsResponse) {
    option (google.api.http) = {
      get: "/v1/billing/invoices/{invoice_id}/payments"
    };
  }
}
