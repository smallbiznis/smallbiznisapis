syntax = "proto3";

package smallbiznis.pricing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/pricing/v1;pricingv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================
// ENUMS
// ======================================

enum PricingModel {
  PRICING_MODEL_UNSPECIFIED = 0;
  PRICING_MODEL_FLAT        = 1; // flat monthly fee
  PRICING_MODEL_METERED     = 2; // based on usage
  PRICING_MODEL_TIERED      = 3; // volume/tiered
  PRICING_MODEL_PACKAGE     = 4; // bundled usage
}

// ======================================
// MODELS
// ======================================

message Plan {
  string id = 1;
  string code = 2;
  string name = 3;
  string description = 4;

  PricingModel pricing_model = 5;

  int64 base_price_cents = 6;
  string currency_code    = 7;

  repeated PlanTier tiers = 10;

  google.protobuf.Struct metadata = 90;

  bool   active = 100;
  google.protobuf.Timestamp created_at = 101;
  google.protobuf.Timestamp updated_at = 102;
}

message PlanTier {
  string metric_code = 1; // "api_calls"
  int64  up_to       = 2; // e.g. up to 10000 calls
  int64  unit_price_cents = 3;
}

// ======================================
// REQUEST / RESPONSE
// ======================================

message GetPlanRequest { string id = 1; }

message ListPlansRequest { bool active_only = 1; }

message ListPlansResponse { repeated Plan plans = 1; }

message GetPlanByCodeRequest { string code = 1; }

message CreatePlanRequest {
  Plan plan = 1;
}

message CreatePlanResponse {
  Plan plan = 1;
}

// ======================================
// SERVICE
// ======================================

service PricingService {

  rpc GetPlan(GetPlanRequest) returns (Plan) {
    option (google.api.http) = {
      get: "/v1/pricing/plans/{id}"
    };
  }

  rpc GetPlanByCode(GetPlanByCodeRequest) returns (Plan) {
    option (google.api.http) = {
      get: "/v1/pricing/plans/code/{code}"
    };
  }

  rpc ListPlans(ListPlansRequest) returns (ListPlansResponse) {
    option (google.api.http) = {
      get: "/v1/pricing/plans"
    };
  }

  rpc CreatePlan(CreatePlanRequest) returns (CreatePlanResponse) {
    option (google.api.http) = {
      post: "/v1/pricing/plans"
      body: "*"
    };
  }
}
