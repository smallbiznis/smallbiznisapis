syntax = "proto3";

package smallbiznis.pricing.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/pricing/v1;pricingv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";

import "protoc-gen-openapiv2/options/annotations.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "Billing API"
    description: ""
    version: "1.0.0"
    contact: {
      name: "Taufik Triantono"
      url: "https://github.com/smallbiznis/corebilling"
      email: "taufiktriantono4@gmail.com"
    }
  }
  host: "api.example.io"
  schemes: [HTTP, HTTPS]
  consumes: "application/json"
  produces: "application/json"
  tags: []
};

// Product is a sellable item defined by a tenant. Products group multiple
// prices and can be attached to subscriptions.
message Product {
  // Unique product identifier.
  string id = 1;
  // Tenant that owns the product catalog entry.
  string tenant_id = 2;
  // Human readable product name.
  string name = 3;
  // Per-tenant unique code for referencing the product via API.
  string code = 4;
  // Optional marketing description.
  string description = 5;
  // Whether the product is available for purchase.
  bool active = 6;
  // Arbitrary product metadata for categorization or integration mappings.
  google.protobuf.Struct metadata = 7;
  // Audit timestamps.
  google.protobuf.Timestamp created_at = 20;
  google.protobuf.Timestamp updated_at = 21;
}

// PricingModel defines how a price charges for usage.
enum PricingModel {
  // Default unspecified value.
  PRICING_MODEL_UNSPECIFIED = 0;
  // Fixed amount per billing interval.
  FLAT = 1;
  // Per-unit charge multiplied by quantity.
  PER_UNIT = 2;
  // Volume pricing where unit price depends on total quantity tier.
  TIERED_VOLUME = 3;
  // Graduated pricing where each tier has its own unit price.
  TIERED_GRADUATED = 4;
}

// BillingUnit defines the logical unit being billed.
enum BillingUnit {
  BILLING_UNIT_UNSPECIFIED = 0;

  API_CALL = 1;
  GB = 2; // decimal (10^9)
  GIB = 3; // binary (2^30)
  MB = 4;
  MIB = 5;
  SECOND = 6;
  MINUTE = 7;
  HOUR = 8;
  SEAT = 9;
}


// TODO: add description for this BillingModel
// BillingMode defines how quantity is determined.
enum BillingMode {
  BILLING_MODE_UNSPECIFIED = 0;

  // Quantity is fixed (e.g. 10 seats, 3 licenses)
  LICENSED = 1;

  // Quantity comes from usage records (metered)
  METERED = 2;
}


// BillingInterval configures how often a recurring price is charged.
enum BillingInterval {
  BILLING_INTERVAL_UNSPECIFIED = 0;
  DAY = 1;
  WEEK = 2;
  MONTH = 3;
  YEAR = 4;
}

// TODO: Add description for AggregateUsage
enum AggregateUsage {
  AGGREGATE_USAGE_UNSPECIFIED = 0;
  SUM = 1;
  MAX = 2;
  LAST = 3;
}

// TODO: add description for ProrationBehavior
enum ProrationBehavior {
  PRORATION_BEHAVIOR_UNSPECIFIED = 0;

  // No proration at all
  NONE = 1;

  // Prorate remaining time and invoice immediately
  CREATE_PRORATIONS = 2;

  // Calculate proration but invoice in next cycle
  DEFERRED = 3;

  // Immediately invoice full new amount
  INVOICE_IMMEDIATELY = 4;
}

// Price represents how a product is billed for a tenant. Prices can be flat,
// per unit, or tiered and are referenced by subscriptions and rating.
message Price {
  // Unique price identifier.
  string id = 1;
  // Owning tenant for scoping and security.
  string tenant_id = 2;
  // Product this price belongs to.
  string product_id = 3;
  // Per-tenant unique code for easy lookup.
  string code = 4;
  // Optional lookup key to maintain stable identifiers across deployments.
  string lookup_key = 5;
  // Pricing strategy for this price.
  PricingModel pricing_model = 6;
  // Reserved field numbers for removed currency/unit_amount fields.
  reserved 7, 8;
  // Billing cadence (monthly, yearly, etc.).
  BillingInterval billing_interval = 9;
  // Number of intervals between billings (e.g., 3 for every 3 months).
  int32 billing_interval_count = 10;
  // Whether the price can be purchased or attached to subscriptions.
  bool active = 11;
  // Arbitrary metadata such as ERP codes.
  google.protobuf.Struct metadata = 12;
  // Optional breakdown of amounts per currency or billing context.
  repeated PriceAmount price_amounts = 13;
  // Default trial duration offered for this price (days).
  int32 trial_period_days = 14;

  BillingUnit billing_unit = 15;
  // Audit timestamps.
  google.protobuf.Timestamp created_at = 20;
  google.protobuf.Timestamp updated_at = 21;
}

// PriceTier defines per-quantity pricing for tiered models.
message PriceTier {
  // Unique identifier for this tier.
  string id = 1;
  // Price the tier belongs to.
  string price_id = 2;
  // Inclusive starting quantity for the tier.
  double start_quantity = 3;
  // Inclusive ending quantity. Use zero/negative for infinity.
  double end_quantity = 4;
  // Unit amount in cents applied within this tier.
  int64 unit_amount_cents = 5;
  // Unit label for display (e.g., "api_call").
  string unit = 6;
  // Arbitrary metadata for documentation or analytics.
  google.protobuf.Struct metadata = 7;
}

// PriceAmount represents a currency-specific amount for a price.
message PriceAmount {
  string id = 1;
  string tenant_id = 2;
  string price_id = 3;
  // Currency of this amount (e.g., "USD", "IDR").
  string currency = 4;
  // Amount in the lowest currency unit (cents).
  int64 amount_cents = 5;
  // Optional contextual metadata.
  google.protobuf.Struct metadata = 6;
  // Audit timestamps.
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

// Requests and responses for basic CRUD operations.
message CreateProductRequest {
  Product product = 1;
}

message GetProductRequest {
  string id = 1;
  string tenant_id = 2;
}

message ListProductsRequest {
  string tenant_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListProductsResponse {
  repeated Product products = 1;
  string next_page_token = 2;
}

message CreatePriceRequest {
  Price price = 1;
  repeated PriceTier tiers = 2;
  repeated PriceAmount price_amounts = 3;
}

message GetPriceRequest {
  string id = 1;
  string tenant_id = 2;
}

message ListPricesRequest {
  string tenant_id = 1;
  string product_id = 2;
  string code = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message ListPricesResponse {
  repeated Price prices = 1;
  repeated PriceTier tiers = 2;
  repeated PriceAmount price_amounts = 3;
  string next_page_token = 4;
}

message ListPriceTiersRequest {
  string tenant_id = 1;
  string price_id = 2;
  int32 page_size = 3;
  string page_token = 4;
}

message ListPriceTiersResponse {
  repeated PriceTier price_tiers = 1;
  string next_page_token = 2;
}

message ListPriceAmountsRequest {
  string tenant_id = 1;
  string price_id = 2;
  string currency = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message ListPriceAmountsResponse {
  repeated PriceAmount price_amounts = 1;
  string next_page_token = 2;
}


// PricingService lets tenants manage products, prices, and tiers used by
// subscriptions and rating.
service PricingService {
  // Create a new product definition for a tenant.
  rpc CreateProduct(CreateProductRequest) returns (Product) {
    option (google.api.http) = {
      post: "/v1/products"
      body: "*"
    };
  };

  // Retrieve a product by ID within a tenant.
  rpc GetProduct(GetProductRequest) returns (Product) {
    option (google.api.http) = {
      get: "/v1/products/{id}"
    };
  };

  // List products for a tenant with pagination.
  rpc ListProducts(ListProductsRequest) returns (ListProductsResponse) {
    option (google.api.http) = {
      get: "/v1/products"
    };
  };

  // Create a price (and optional tiers) for a product.
  rpc CreatePrice(CreatePriceRequest) returns (Price) {
    option (google.api.http) = {
      post: "/v1/prices"
      body: "*"
    };
  };

  // Retrieve a price by ID within a tenant.
  rpc GetPrice(GetPriceRequest) returns (Price) {
    option (google.api.http) = {
      get: "/v1/prices/{id}"
    };
  };

  // List prices filtered by tenant/product/code with pagination. Tiers are
  // returned alongside their parent prices.
  rpc ListPrices(ListPricesRequest) returns (ListPricesResponse) {
    option (google.api.http) = {
      get: "/v1/prices"
    };
  };

  // List tiers for prices within a tenant context.
  rpc ListPriceTiers(ListPriceTiersRequest) returns (ListPriceTiersResponse) {
    option (google.api.http) = {
      get: "/v1/tiers"
    };
  };

  // List currency-specific amounts for prices within a tenant context.
  rpc ListPriceAmounts(ListPriceAmountsRequest) returns (ListPriceAmountsResponse) {
    option (google.api.http) = {
      get: "/v1/amounts"
    };
  };
}
