syntax = "proto3";

package smallbiznis.rating.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/rating/v1;ratingv1";

import "google/protobuf/timestamp.proto";
import "google/type/money.proto";

message RatedLineItem {
  string price_id = 1;
  string meter_id = 2;
  double quantity = 3;
  google.type.Money unit_amount = 4;
  google.type.Money subtotal = 5;
}

message RatingResult {
  string subscription_id = 1;
  repeated RatedLineItem line_items = 2;
  google.protobuf.Timestamp rated_at = 3;
  // Customer that this rating result applies to (references smallbiznis.customer.v1.Customer.id).
  string customer_id = 4;
}

message RateSubscriptionRequest {
  string subscription_id = 1;
  google.protobuf.Timestamp period_start = 2;
  google.protobuf.Timestamp period_end = 3;
}

message RateSubscriptionResponse {
  RatingResult result = 1;
}

// RatingCompletedV2 is emitted for rating.completed.v2 events and includes the customer context.
message RatingCompletedV2 {
  // Tenant namespace that owns the rated subscription (SmallBiznis Cloud or a tenant such as Company A).
  string tenant_id = 1;
  // Customer that owns the subscription being rated (Company A or its downstream customer).
  string customer_id = 2;
  string subscription_id = 3;
  RatingResult result = 4;
}

message RatePriceRequest {
  string subscription_id = 1;
  google.protobuf.Timestamp period_start = 2;
  google.protobuf.Timestamp period_end = 3;
}

message RatePriceResponse {
  RatedLineItem line_item = 1;
}

service RatingService {
  rpc RateSubscription(RateSubscriptionRequest) returns (RateSubscriptionResponse);
  rpc RatePrice(RatePriceRequest) returns (RatePriceResponse);
}
