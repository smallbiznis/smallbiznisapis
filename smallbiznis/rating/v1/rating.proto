syntax = "proto3";

package smallbiznis.rating.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/rating/v1;ratingv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

// =======================
// Rating Result
// =======================

message RatingResult {
  string id = 1;

  string tenant_id = 2;
  string customer_id = 3;
  string subscription_id = 4;

  google.protobuf.Timestamp period_start = 5;
  google.protobuf.Timestamp period_end = 6;

  repeated RatingResultItem items = 7;

  google.protobuf.Timestamp rated_at = 8;
  google.protobuf.Struct metadata = 9;
}

message RatingResultItem {
  string id = 1;
  string rating_result_id = 2;

  string subscription_item_id = 3;
  string meter_id = 4;
  string meter_code = 5;

  double quantity = 6;

  // SNAPSHOT (important)
  int64 unit_amount_cents = 7;
  int64 amount_cents = 8;
  string currency_code = 9;

  google.protobuf.Struct metadata = 10;
}

// =======================
// APIs
// =======================

message RateSubscriptionRequest {
  string tenant_id = 1;
  string subscription_id = 2;
  google.protobuf.Timestamp period_start = 3;
  google.protobuf.Timestamp period_end = 4;
}

message RateSubscriptionResponse {
  RatingResult result = 1;
}

message ListRatingRequest {
  string tenant_id = 1;
  string subscription_id = 2;
  google.protobuf.Timestamp period_start = 3;
  google.protobuf.Timestamp period_end = 4;
  int32 page_size = 5;
  string page_token = 6;
}

message ListRatingResponse {
  repeated RatingResult results = 1;
  string next_page_token = 2;
}

service RatingService {
  rpc RateSubscription(RateSubscriptionRequest)
      returns (RateSubscriptionResponse);

  rpc ListRating(ListRatingRequest)
      returns (ListRatingResponse);
}
