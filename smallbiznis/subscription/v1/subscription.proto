syntax = "proto3";

package smallbiznis.subscription.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/subscription/v1;subscriptionv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

// Subscription ties a tenant's customer to a price. It drives usage collection,
// rating, and invoicing. Subscriptions are always scoped to a tenant.
message Subscription {
  // Unique subscription identifier.
  string id = 1;
  // Tenant that owns this subscription.
  string tenant_id = 2;
  // Customer that will be billed.
  string customer_id = 3;
  // Price that defines billing behavior (recurring/usage/tiered).
  string price_id = 4;
  // Current lifecycle status of the subscription.
  SubscriptionStatus status = 5;
  // Whether the subscription auto-renews at period end.
  bool auto_renew = 6;
  // Subscription start time.
  google.protobuf.Timestamp start_at = 7;
  // Start of the current billing period.
  google.protobuf.Timestamp current_period_start = 8;
  // End of the current billing period.
  google.protobuf.Timestamp current_period_end = 9;
  // Optional trial window start time.
  google.protobuf.Timestamp trial_start_at = 10;
  // Optional trial window end time.
  google.protobuf.Timestamp trial_end_at = 11;
  // Scheduled cancellation time (cancel at period end).
  google.protobuf.Timestamp cancel_at = 12;
  // Timestamp when the subscription was canceled.
  google.protobuf.Timestamp canceled_at = 13;
  // Arbitrary metadata for downstream systems.
  google.protobuf.Struct metadata = 14;
}

// SubscriptionStatus describes lifecycle states for billing and provisioning.
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_ACTIVE = 1;
  SUBSCRIPTION_STATUS_TRIALING = 2;
  SUBSCRIPTION_STATUS_CANCELED = 3;
  SUBSCRIPTION_STATUS_PAST_DUE = 4;
  SUBSCRIPTION_STATUS_INCOMPLETE = 5;
}

// Request to create a subscription linking a customer to a price.
message CreateSubscriptionRequest {
  string tenant_id = 1;
  string customer_id = 2;
  string price_id = 3;
  // Optional trial start/end times if the price includes a trial.
  google.protobuf.Timestamp trial_start_at = 4;
  google.protobuf.Timestamp trial_end_at = 5;
  // Whether to auto-renew at the end of the billing period.
  bool auto_renew = 6;
  // Optional metadata to store with the subscription.
  google.protobuf.Struct metadata = 7;
}

// Request to fetch a subscription by ID.
message GetSubscriptionRequest {
  string id = 1;
  string tenant_id = 2;
}

// Request to list subscriptions for a tenant or customer.
message ListSubscriptionsRequest {
  string tenant_id = 1;
  string customer_id = 2;
  int32 page_size = 3;
  string page_token = 4;
}

// Response containing subscriptions and pagination token.
message ListSubscriptionsResponse {
  repeated Subscription subscriptions = 1;
  string next_page_token = 2;
}

// Request to cancel a subscription (immediate or at period end).
message CancelSubscriptionRequest {
  string id = 1;
  // If true, cancel at current_period_end; otherwise cancel immediately.
  bool cancel_at_period_end = 2;
  string tenant_id = 3;
}

// SubscriptionService manages subscription lifecycle for tenant customers.
service SubscriptionService {
  // Create a new subscription for a customer and price.
  rpc CreateSubscription(CreateSubscriptionRequest) returns (Subscription);

  // Retrieve a subscription by ID.
  rpc GetSubscription(GetSubscriptionRequest) returns (Subscription);

  // List subscriptions for a tenant with optional customer filter.
  rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse);

  // Cancel a subscription either immediately or at period end.
  rpc CancelSubscription(CancelSubscriptionRequest) returns (Subscription);
}
