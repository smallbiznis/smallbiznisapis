syntax = "proto3";

package smallbiznis.subscription.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/subscription/v1;subscriptionv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";

import "smallbiznis/pricing/v1/pricing.proto";


// ==============================
// ENUMS
// ==============================

enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  TRIALING = 2;
  CANCELED = 3;
  PAST_DUE = 4;
  INCOMPLETE = 5;
}

enum SubscriptionCollectionMode {
  SUBSCRIPTION_COLLECTION_MODE_UNSPECIFIED = 0;
  SEND_INVOICE = 1;
  CHARGE_AUTOMATICALLY = 2;
}

enum TaxBehavior {
  TAX_BEHAVIOR_UNSPECIFIED = 0;
  INCLUSIVE = 1;
  EXCLUSIVE = 2;
  INLINE = 3;
}

// ==============================
// SUBSCRIPTION
// ==============================

message Subscription {
  string id = 1;
  string tenant_id = 2;
  string customer_id = 3;

  SubscriptionStatus status = 4;
  bool auto_renew = 5;

  google.protobuf.Timestamp start_at = 6;
  google.protobuf.Timestamp end_at = 7;

  google.protobuf.Timestamp cancel_at = 8;
  google.protobuf.Timestamp canceled_at = 9;
  bool cancel_at_period_end = 10;

  SubscriptionCollectionMode collection_mode = 11;

  int32 billing_anchor_day = 12;
  string billing_cycle_type = 13;
  string current_billing_cycle_id = 14;

  int32 default_payment_term_days = 15;
  string default_currency = 16;
  TaxBehavior default_tax_behavior = 17;

  google.protobuf.Struct metadata = 18;

  google.protobuf.Timestamp created_at = 19;
  google.protobuf.Timestamp updated_at = 20;
}


// ==============================
// SUBSCRIPTION ITEM
// ==============================

message SubscriptionItem {
  string id = 1;
  string tenant_id = 2;
  string subscription_id = 3;

  // Pricing reference
  string price_id = 4;
  string meter_id = 5;

  // Quantity for LICENSED billing
  double quantity = 6;

  // Billing behavior
  smallbiznis.pricing.v1.BillingMode billing_mode = 7;
  smallbiznis.pricing.v1.AggregateUsage aggregate_usage = 8;
  double billing_threshold = 9;
  smallbiznis.pricing.v1.ProrationBehavior proration_behavior = 10;

  google.protobuf.Struct metadata = 11;

  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}


// ==============================
// CREATE REQUESTS
// ==============================

message CreateSubscriptionItem {
  string price_id = 1;
  string meter_id = 2;
  double quantity = 3;

  smallbiznis.pricing.v1.BillingMode billing_mode = 4;
  smallbiznis.pricing.v1.AggregateUsage aggregate_usage = 5;
  double billing_threshold = 6;
  smallbiznis.pricing.v1.ProrationBehavior proration_behavior = 7;

  google.protobuf.Struct metadata = 8;
}

message CreateSubscriptionRequest {
  string tenant_id = 1;
  string customer_id = 2;

  google.protobuf.Timestamp trial_start_at = 3;
  google.protobuf.Timestamp trial_end_at = 4;

  bool auto_renew = 5;
  SubscriptionCollectionMode collection_mode = 6;

  int32 billing_anchor_day = 7;
  string billing_cycle_type = 8;
  int32 default_payment_term_days = 9;
  string default_currency = 10;
  TaxBehavior default_tax_behavior = 11;

  google.protobuf.Struct metadata = 12;
  repeated CreateSubscriptionItem items = 13;
}


// ==============================
// QUERY & LIFECYCLE
// ==============================

message GetSubscriptionRequest {
  string id = 1;
  string tenant_id = 2;
}

message ListSubscriptionsRequest {
  string tenant_id = 1;
  string customer_id = 2;
  SubscriptionStatus status = 3;

  google.protobuf.Timestamp period_start = 4;
  google.protobuf.Timestamp period_end = 5;

  int32 page_size = 6;
  string page_token = 7;
}

message ListSubscriptionsResponse {
  repeated Subscription subscriptions = 1;
  string next_page_token = 2;
}

message CancelSubscriptionRequest {
  string id = 1;
  string tenant_id = 2;
  bool cancel_at_period_end = 3;
}

// ==============================
// SERVICE
// ==============================

service SubscriptionService {
  rpc CreateSubscription(CreateSubscriptionRequest) returns (Subscription) {
    option (google.api.http) = {
      post: "/v1/subscriptions"
      body: "*"
    };
  }

  rpc GetSubscription(GetSubscriptionRequest) returns (Subscription) {
    option (google.api.http) = {
      get: "/v1/subscriptions/{id}"
    };
  }

  rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse) {
    option (google.api.http) = {
      get: "/v1/subscriptions"
    };
  }

  rpc CancelSubscription(CancelSubscriptionRequest) returns (Subscription) {
    option (google.api.http) = {
      post: "/v1/subscriptions/{id}/cancel"
      body: "*"
    };
  }
}
