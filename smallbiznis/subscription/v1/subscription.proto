// IMPORTANT: LOCKED SPEC. Only change with explicit migration.
syntax = "proto3";

package smallbiznis.subscription.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/subscription/v1;subscriptionv1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/api/annotations.proto";

// ===============================================================
// ENUMS
// ===============================================================

enum BillingInterval {
  BILLING_INTERVAL_UNSPECIFIED = 0;
  MONTHLY = 1;
  YEARLY = 2;
  WEEKLY = 3;
  DAILY = 4;
}

enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  TRIALING = 2;
  PAST_DUE = 3;
  CANCELED = 4;
  INCOMPLETE = 5;
  TRIAL_EXPIRED = 6;
}

enum ProrationBehavior {
  PRORATION_BEHAVIOR_UNSPECIFIED = 0;
  PRORATE = 1;
  NO_PRORATE = 2;
}

// ===============================================================
// DOMAIN MODEL
// ===============================================================
// NOTE:
// Plan definition TIDAK ADA DI SINI lagi.
// Plan hanya diambil dari PricingService, dan Subscription hanya referensikan plan_id & plan_code.
//

message Subscription {
  string id = 1;

  string tenant_id = 2;
  string customer_id = 3;

  // reference to pricing module
  string plan_code = 4;
  string plan_id = 5;

  SubscriptionStatus status = 6;

  bool auto_renew = 7;
  bool allow_overage_billing = 8;

  google.protobuf.Timestamp start_at = 9;
  google.protobuf.Timestamp current_period_start = 10;
  google.protobuf.Timestamp current_period_end = 11;

  google.protobuf.Timestamp trial_start_at = 12;
  google.protobuf.Timestamp trial_end_at = 13;

  google.protobuf.Timestamp cancel_at = 14;
  google.protobuf.Timestamp canceled_at = 15;

  google.protobuf.Struct metadata = 16;
}

// ===============================================================
// EVENTS
// ===============================================================

message SubscriptionCreatedEvent {
  string subscription_id = 1;
  string tenant_id = 2;
  string plan_code = 3;
  int32 trial_days = 4;
  google.protobuf.Timestamp occurred_at = 5;
}

// ===============================================================
// REQUEST / RESPONSE
// ===============================================================

message CreateSubscriptionRequest {
  string tenant_id = 1;
  string customer_id = 2;

  // must match pricing plan
  string plan_code = 3;
  string plan_id = 4;

  int32 trial_days_override = 5;

  bool start_immediately = 6;
}

message CreateSubscriptionResponse {
  Subscription subscription = 1;
}

message GetSubscriptionRequest {
  string id = 1;
  string tenant_id = 2;
}

message GetSubscriptionResponse {
  Subscription subscription = 1;
}

message ListSubscriptionsRequest {
  string tenant_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListSubscriptionsResponse {
  repeated Subscription subscriptions = 1;
  string next_page_token = 2;
}

message CancelSubscriptionRequest {
  string id = 1;
  bool cancel_at_period_end = 2;
}

message CancelSubscriptionResponse {
  Subscription subscription = 1;
}

message ChangeSubscriptionPlanRequest {
  string id = 1;
  string new_plan_code = 2;
  string new_plan_id = 3;
  ProrationBehavior proration_behavior = 4;
}

message ChangeSubscriptionPlanResponse {
  Subscription subscription = 1;
}

// ===============================================================
// SERVICE
// ===============================================================

service SubscriptionService {

  rpc CreateSubscription(CreateSubscriptionRequest)
      returns (CreateSubscriptionResponse) {
    option (google.api.http) = {
      post: "/v1/subscriptions"
      body: "*"
    };
  }

  rpc GetSubscription(GetSubscriptionRequest)
      returns (GetSubscriptionResponse) {
    option (google.api.http) = {
      get: "/v1/subscriptions:get"
    };
  }

  rpc ListSubscriptions(ListSubscriptionsRequest)
      returns (ListSubscriptionsResponse) {
    option (google.api.http) = {
      get: "/v1/subscriptions"
    };
  }

  rpc CancelSubscription(CancelSubscriptionRequest)
      returns (CancelSubscriptionResponse) {
    option (google.api.http) = {
      post: "/v1/subscriptions/{id}:cancel"
      body: "*"
    };
  }

  rpc ChangeSubscriptionPlan(ChangeSubscriptionPlanRequest)
      returns (ChangeSubscriptionPlanResponse) {
    option (google.api.http) = {
      post: "/v1/subscriptions/{id}:change-plan"
      body: "*"
    };
  }
}
