syntax = "proto3";

package smallbiznis.tenant.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/tenant/v1;tenantv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";

// Tenant represents a company account within SmallBiznis Cloud. Tenants can be
// organized hierarchically to mirror Stripe Connect style parent/child
// accounts. All billing entities such as customers, subscriptions, usage, and
// invoices are scoped to a specific tenant.
message Tenant {
  // Globally unique tenant identifier (Snowflake/ULID as string).
  string id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];

  // Optional parent tenant. Empty for the SmallBiznis platform root or top
  // level accounts. Enables connected account hierarchies.
  string parent_id = 2 [(google.api.field_behavior) = IMMUTABLE];

  // Type of tenant: platform root or connected account.
  TenantType type = 3 [(google.api.field_behavior) = REQUIRED];

  // Human readable display name for the tenant.
  string name = 4 [(google.api.field_behavior) = REQUIRED];

  // URL-safe unique slug used for dashboards or API routing (per tenant unique).
  string slug = 5 [(google.api.field_behavior) = REQUIRED];

  // Current lifecycle status controlling access to billing APIs.
  TenantStatus status = 6 [(google.api.field_behavior) = REQUIRED];

  // Default currency used for pricing and invoicing when no customer override
  // is provided. Examples: "IDR", "USD".
  string default_currency = 7 [(google.api.field_behavior) = REQUIRED];

  // ISO-3166 country code representing the tenant's primary legal entity.
  string country_code = 8 [(google.api.field_behavior) = REQUIRED];

  // Timestamps for auditing and data lineage.
  google.protobuf.Timestamp created_at = 9
      [(google.api.field_behavior) = OUTPUT_ONLY];
  google.protobuf.Timestamp updated_at = 10
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Arbitrary key/value metadata persisted with the tenant record.
  google.protobuf.Struct metadata = 11;
}

// TenantType distinguishes the SmallBiznis platform root from connected
// accounts created by customers.
enum TenantType {
  // Default unspecified value.
  TENANT_TYPE_PLATFORM = 0;
  // Connected account belonging to a platform tenant.
  TENANT_TYPE_CONNECTED_ACCOUNT = 1;
}

// TenantStatus indicates whether a tenant can access billing APIs.
enum TenantStatus {
  // Default unspecified value.
  TENANT_STATUS_UNSPECIFIED = 0;
  // Active tenants may create customers, subscriptions, and usage.
  TENANT_STATUS_ACTIVE = 1;
  // Suspended tenants are temporarily blocked from API actions.
  TENANT_STATUS_SUSPENDED = 2;
  // Closed tenants are permanently disabled and cannot be reactivated.
  TENANT_STATUS_CLOSED = 3;
}

// CreateTenantRequest registers a new tenant. Parent/child relationships are
// optional and allow platform accounts to manage connected accounts.
message CreateTenantRequest {
  // Optional parent tenant ID for connected account creation.
  string parent_id = 1;
  // Display name of the tenant.
  string name = 2 [(google.api.field_behavior) = REQUIRED];
  // Unique slug within the parent scope.
  string slug = 3 [(google.api.field_behavior) = REQUIRED];
  // Default currency applied to pricing and invoices.
  string default_currency = 4 [(google.api.field_behavior) = REQUIRED];
  // ISO-3166 country code for regulatory context.
  string country_code = 5 [(google.api.field_behavior) = REQUIRED];
  // Arbitrary metadata stored alongside the tenant.
  google.protobuf.Struct metadata = 6;
}

// Request to retrieve a single tenant by identifier.
message GetTenantRequest {
  // Tenant identifier to fetch.
  string id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];
}

// ListTenantsRequest filters tenants by parent and supports pagination.
message ListTenantsRequest {
  // Optional parent tenant ID to list children. Empty lists all tenants
  // accessible to the caller.
  string parent_id = 1;
  // Maximum number of tenants to return.
  int32 page_size = 2;
  // Pagination token from a previous ListTenantsResponse.
  string page_token = 3;
}

// Paginated tenant list response.
message ListTenantsResponse {
  // Tenants matching the filter.
  repeated Tenant tenants = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Token to request the next page of results.
  string next_page_token = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// UpdateTenantRequest updates mutable tenant fields.
message UpdateTenantRequest {
  // Tenant identifier to update.
  string id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.field_behavior) = IMMUTABLE
  ];
  // Updated display name.
  string name = 2 [(google.api.field_behavior) = OPTIONAL];
  // Updated slug (must remain unique within parent scope).
  string slug = 3 [(google.api.field_behavior) = OPTIONAL];
  // Updated status (e.g., suspend or close tenant access).
  TenantStatus status = 4 [(google.api.field_behavior) = OPTIONAL];
  // Updated default currency.
  string default_currency = 5 [(google.api.field_behavior) = OPTIONAL];
  // Updated country code if the legal entity moves.
  string country_code = 6 [(google.api.field_behavior) = OPTIONAL];
  // Metadata merge/replace based on server behavior.
  google.protobuf.Struct metadata = 7;
}

// TenantService manages hierarchical tenant accounts and their lifecycle.
service TenantService {
  // Create a new tenant (platform root or connected account).
  rpc CreateTenant(CreateTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      post: "/v1/tenants"
      body: "*"
    };
  }

  // Retrieve a tenant by ID.
  rpc GetTenant(GetTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      get: "/v1/tenants/{id}"
    };
  }

  // List tenants optionally filtered by parent account.
  rpc ListTenants(ListTenantsRequest) returns (ListTenantsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants"
    };
  }

  // Update mutable tenant attributes such as status or metadata.
  rpc UpdateTenant(UpdateTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      patch: "/v1/tenants/{id}"
      body: "*"
    };
  }
}
