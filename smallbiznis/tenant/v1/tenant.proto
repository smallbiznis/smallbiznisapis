syntax = "proto3";

package smallbiznis.tenant.v1;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "github.com/smallbiznis/smallbiznis-monorepo/proto/tenant/v1;tenantv1";

// OpenAPI top-level config
option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "SmallBiznis API";
    version: "1.0";
    description: "Multi-tenant, global-ready Organization & Onboarding APIs";
    contact: {
      name: "SmallBiznis project";
      url: "https://github.com/smallbiznis";
      email: "taufiktriantono4@gmail.com";
    };
  };
  host: "api.smallbiznis.test";
  schemes: HTTPS;
  base_path: "/api";
  consumes: "application/json";
  produces: "application/json";
};

// ======================================
// TenantService
// ======================================
service TenantService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "Tenant"
    description: "API for managing tenants"
  };

  rpc CreateTenant(CreateTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      post: "/v1/tenants"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "Create a new tenant"
      description: ""
      operation_id: "Tenant_Create"
    };
  }

  rpc GetTenant(GetTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "Get a tenant"
      description: ""
      operation_id: "Tenant_Get"
    };
  }

  rpc ListTenants(ListTenantsRequest) returns (ListTenantsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "List tenants"
      description: ""
      operation_id: "Tenant_List"
    };
  }

  rpc UpdateTenant(UpdateTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      patch: "/v1/tenants/{tenant_id}"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "Update a tenant"
      description: ""
      operation_id: "Tenant_Update"
    };
  }

  rpc DeleteTenant(DeleteTenantRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/v1/tenants/{tenant_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "Delete a tenant"
      description: ""
      operation_id: "Tenant_Delete"
    };
  }

  rpc ListMyTenant(ListMyTenantsRequest) returns (ListTenantsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/my"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "List my tenants"
      description: ""
      operation_id: "Tenant_ListMy"
    };
  }

  rpc ListTenantUsers(ListTenantUsersRequest) returns (ListTenantUsersResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant_id}/users"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "List tenant users"
      description: ""
      operation_id: "Tenant_ListUsers"
    };
  }

  rpc InviteTenantUser(InviteTenantUserRequest) returns (InviteTenantUserResponse) {
    option (google.api.http) = {
      post: "/v1/tenants/{tenant_id}/invite"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "Invite a user to a tenant"
      description: ""
      operation_id: "Tenant_InviteUser"
    };
  }

  rpc UpdateTenantUserRole(UpdateTenantUserRoleRequest) returns (UpdateTenantUserRoleResponse) {
    option (google.api.http) = {
      patch: "/v1/tenant_users/{tenant_user_id}/role"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      tags: "Tenant"
      summary: "Update tenant user role"
      description: ""
      operation_id: "Tenant_UpdateUserRole"
    };
  }

}

enum TenantUserRole {
  TENANT_USER_ROLE_UNSPECIFIED = 0;
  OWNER = 1;
  ADMIN = 2;
  STAFF = 3;
}

enum TenantUserStatus {
  TENANT_USER_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  INVITED = 2;
  DISABLED = 3;
}

// =======================
// ENTITIES
// =======================
message Tenant {
  string tenant_id = 1;
  string type = 2;
  string name = 3;
  string slug = 4;
  string country_code = 5; // ISO alpha-2
  string timezone = 6; // Asia/Jakarta
  string status = 7; // pending, provisioning, active, suspended, archived
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  string code = 10;
}

message TenantUser {
  string tenant_user_id = 1;
  string tenant_id = 2;
  string user_id = 3;
  TenantUserRole role = 4;
  bool is_default = 5;
  TenantUserStatus status = 6;
  google.protobuf.Timestamp joined_at = 7;

  // optional embedded tenant info
  Tenant tenant = 8;
}

// =======================
// REQUESTS / RESPONSES
// =======================
message CreateTenantRequest {
  string name = 1;
  string slug = 2;
  string country_code = 3; // ISO alpha-2
  string timezone = 4; // Asia/Jakarta
  string type = 5; // company, personal
}

message GetTenantRequest {
  string tenant_id = 1;
}

message ListTenantsRequest {
  string cursor = 1;
  int32 limit = 2;
  string status = 3;
}

message ListTenantsResponse {
  repeated Tenant tenants = 1;
  string next_cursor = 2;
  string prev_cursor = 3;
  bool has_more = 4;
  int32 total_count = 5;
}

message UpdateTenantRequest {
  string tenant_id = 1;
  string name = 2;
  string status = 4;
}

message DeleteTenantRequest {
  string tenant_id = 1;
}

message ListMyTenantsRequest {}

message ListMyTenantsResponse {
  repeated Tenant tenants = 1;
}

message ListTenantUsersRequest {
  string tenant_id = 1;
}

message ListTenantUsersResponse {
  repeated TenantUser users = 1;
}

message TenantUserInput {
  string email = 1;
  TenantUserRole role = 2;
}

message InviteTenantUserRequest {
  string tenant_id = 1;
  TenantUserInput user = 2;
}

message InviteTenantUserResponse {
  TenantUser invitation = 1;
}

message UpdateTenantUserRoleRequest {
  string tenant_user_id = 1;
  TenantUserRole new_role = 2;
}

message UpdateTenantUserRoleResponse {
  TenantUser updated = 1;
}
