syntax = "proto3";

package smallbiznis.tenant.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/tenant/v1;tenantv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum TenantStatus {
  TENANT_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  SUSPENDED = 2;
  DISABLED = 3;
  DELETED = 4;
}

enum TenantUserRole {
  TENANT_USER_ROLE_UNSPECIFIED = 0;
  OWNER = 1;
  ADMIN = 2;
  STAFF = 3;
  VIEWER = 4;
}

enum TenantUserStatus {
  TENANT_USER_STATUS_UNSPECIFIED = 0;
  INVITED = 1;
  ACTIVE_USER = 2;
  SUSPENDED_USER = 3;
  REMOVED = 4;
}

// ======================================================
// MODELS
// ======================================================

message Tenant {
  // Snowflake ID as string (JS-safe)
  string id = 1;

  string name = 2;
  string slug = 3;

  TenantStatus status = 4;

  // pointer to subscription service (no FK on DB)
  string current_plan_code = 5;
  string current_subscription_id = 6;

  // platform-wide user id (from auth service)
  string owner_user_id = 7;

  google.protobuf.Struct metadata = 8;

  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

message TenantUser {
  string id = 1;
  string tenant_id = 2;
  string user_id = 3;

  TenantUserRole role = 4;
  TenantUserStatus status = 5;

  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

// ======================================================
// EVENTS (for NATS / EventBus)
// ======================================================

message TenantCreatedEvent {
  string tenant_id = 1;
  string slug = 2;
  string owner_user_id = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

message TenantUserAddedEvent {
  string tenant_user_id = 1;
  string tenant_id = 2;
  string user_id = 3;
  TenantUserRole role = 4;
  google.protobuf.Timestamp occurred_at = 5;
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

message CreateTenantRequest {
  string name = 1;
  string slug = 2;
  string owner_user_id = 3;
}

message CreateTenantResponse {
  Tenant tenant = 1;
}

message GetTenantRequest {
  string id = 1;
}

message GetTenantResponse {
  Tenant tenant = 1;
}

message ListTenantsRequest {
  int32 page_size = 1;
  string page_token = 2;
}

message ListTenantsResponse {
  repeated Tenant tenants = 1;
  string next_page_token = 2;
}

message AddTenantUserRequest {
  string tenant_id = 1;
  string user_id = 2;
  TenantUserRole role = 3;
}

message AddTenantUserResponse {
  TenantUser tenant_user = 1;
}

message ListTenantUsersRequest {
  string tenant_id = 1;
}

message ListTenantUsersResponse {
  repeated TenantUser tenant_users = 1;
}

message ChangeTenantUserRoleRequest {
  string id = 1;
  TenantUserRole new_role = 2;
}

message ChangeTenantUserRoleResponse {
  TenantUser tenant_user = 1;
}

// (opsional tapi berguna) update basic info tenant
message UpdateTenantRequest {
  string id = 1;
  string name = 2;
  string slug = 3;
  TenantStatus status = 4;
  google.protobuf.Struct metadata = 5;
}

message UpdateTenantResponse {
  Tenant tenant = 1;
}

// ======================================================
// TENANT SERVICE
// ======================================================

service TenantService {

  rpc CreateTenant(CreateTenantRequest)
      returns (CreateTenantResponse) {
    option (google.api.http) = {
      post: "/v1/tenants"
      body: "*"
    };
  }

  rpc GetTenant(GetTenantRequest)
      returns (GetTenantResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/{id}"
    };
  }

  rpc ListTenants(ListTenantsRequest)
      returns (ListTenantsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants"
    };
  }

  rpc UpdateTenant(UpdateTenantRequest)
      returns (UpdateTenantResponse) {
    option (google.api.http) = {
      patch: "/v1/tenants/{id}"
      body: "*"
    };
  }

  rpc AddTenantUser(AddTenantUserRequest)
      returns (AddTenantUserResponse) {
    option (google.api.http) = {
      post: "/v1/tenants/{tenant_id}/users"
      body: "*"
    };
  }

  rpc ListTenantUsers(ListTenantUsersRequest)
      returns (ListTenantUsersResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant_id}/users"
    };
  }

  rpc ChangeTenantUserRole(ChangeTenantUserRoleRequest)
      returns (ChangeTenantUserRoleResponse) {
    option (google.api.http) = {
      post: "/v1/tenant-users/{id}:change-role"
      body: "*"
    };
  }
}
