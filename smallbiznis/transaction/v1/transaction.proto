syntax = "proto3";

package smallbiznis.transaction.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/transaction/v1;transactionv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  PENDING = 1;
  PAID = 2;
  CANCELLED = 3;
  REFUNDED = 4;
  FULFILLED = 5;
  COMPLETED = 6;
}

enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_PENDING = 1;
  PAYMENT_SUCCESS = 2;
  PAYMENT_FAILED = 3;
}

enum PaymentMethod {
  PAYMENT_METHOD_UNSPECIFIED = 0;
  CASH = 1;
  CARD = 2;
  EWALLET = 3;
  BANK_TRANSFER = 4;
  QRIS = 5;
  INTERNAL_BALANCE = 6;
}

enum FulfillmentType {
  FULFILLMENT_TYPE_UNSPECIFIED = 0;
  DINE_IN = 1;
  TAKE_AWAY = 2;
  DELIVERY = 3;
}

enum DiscountType {
  DISCOUNT_TYPE_UNSPECIFIED = 0;
  FIXED = 1;
  PERCENT = 2;
}

// ======================================================
// MODELS
// ======================================================

message Order {
  string id = 1;
  string tenant_id = 2;
  string customer_id = 3;       // optional, if CRM future
  string location_id = 4;       // outlet/store
  FulfillmentType fulfillment_type = 5;

  int64 subtotal_cents = 6;
  int64 discount_cents = 7;
  int64 tax_cents = 8;
  int64 total_cents = 9;

  OrderStatus status = 10;
  PaymentStatus payment_status = 11;

  string note = 12;

  google.protobuf.Struct metadata = 13;

  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
}

message OrderItem {
  string id = 1;
  string order_id = 2;
  string product_id = 3;
  string variant_id = 4;

  string name = 5;     // copy from product
  int64 price_cents = 6;
  int64 quantity = 7;
  int64 subtotal_cents = 8;

  google.protobuf.Struct metadata = 9;

  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

message OrderItemAddon {
  string id = 1;
  string order_item_id = 2;

  string product_id = 3;
  string variant_id = 4;

  string name = 5;
  int64 price_cents = 6;
  int64 quantity = 7;

  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

message Payment {
  string id = 1;
  string order_id = 2;

  int64 amount_cents = 3;
  PaymentStatus status = 4;
  PaymentMethod method = 5;

  string provider_ref = 6;
  google.protobuf.Struct metadata = 7;

  google.protobuf.Timestamp created_at = 8;
}

message OrderDiscount {
  string id = 1;
  string order_id = 2;

  DiscountType type = 3;
  int64 value = 4;          // percentage or fixed amount
  string source = 5;        // voucher_id / campaign_id / system
  string description = 6;

  google.protobuf.Timestamp created_at = 7;
}

// ======================================================
// EVENTS
// ======================================================

message OrderCreatedEvent {
  string order_id = 1;
  string tenant_id = 2;
  int64 total_cents = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

message OrderPaidEvent {
  string order_id = 1;
  string tenant_id = 2;
  int64 amount_cents = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

message OrderItemFulfilledEvent {
  string order_id = 1;
  string variant_id = 2;
  int64 quantity = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

message CreateOrderItem {
  string product_id = 1;
  string variant_id = 2;
  int64 quantity = 3;
  google.protobuf.Struct metadata = 4;
}

message CreateOrderAddon {
  string product_id = 1;
  string variant_id = 2;
  int64 quantity = 3;
}

message CreateOrderRequest {
  string tenant_id = 1;
  string customer_id = 2;
  string location_id = 3;
  FulfillmentType fulfillment_type = 4;

  repeated CreateOrderItem items = 5;
  repeated CreateOrderAddon addons = 6;

  google.protobuf.Struct metadata = 7;
}

message CreateOrderResponse {
  Order order = 1;
}

message AddPaymentRequest {
  string order_id = 1;
  PaymentMethod method = 2;
  int64 amount_cents = 3;
  google.protobuf.Struct metadata = 4;
}

message AddPaymentResponse {
  Payment payment = 1;
}

message ApplyDiscountRequest {
  string order_id = 1;

  DiscountType type = 2;
  int64 value = 3;

  string source = 4;
  string description = 5;
}

message ApplyDiscountResponse {
  OrderDiscount discount = 1;
}

message GetOrderRequest {
  string id = 1;
}

message GetOrderResponse {
  Order order = 1;
  repeated OrderItem items = 2;
  repeated OrderItemAddon addons = 3;
  repeated Payment payments = 4;
  repeated OrderDiscount discounts = 5;
}

message ListOrdersRequest {
  string tenant_id = 1;
  string location_id = 2;
  OrderStatus status_filter = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message ListOrdersResponse {
  repeated Order orders = 1;
  string next_page_token = 2;
}

// ======================================================
// SERVICE
// ======================================================

service TransactionService {

  rpc CreateOrder(CreateOrderRequest)
      returns (CreateOrderResponse) {
    option (google.api.http) = {
      post: "/v1/orders"
      body: "*"
    };
  }

  rpc AddPayment(AddPaymentRequest)
      returns (AddPaymentResponse) {
    option (google.api.http) = {
      post: "/v1/orders/{order_id}/payments"
      body: "*"
    };
  }

  rpc ApplyDiscount(ApplyDiscountRequest)
      returns (ApplyDiscountResponse) {
    option (google.api.http) = {
      post: "/v1/orders/{order_id}/discounts"
      body: "*"
    };
  }

  rpc GetOrder(GetOrderRequest)
      returns (GetOrderResponse) {
    option (google.api.http) = {
      get: "/v1/orders/{id}"
    };
  }

  rpc ListOrders(ListOrdersRequest)
      returns (ListOrdersResponse) {
    option (google.api.http) = {
      get: "/v1/orders"
    };
  }
}
