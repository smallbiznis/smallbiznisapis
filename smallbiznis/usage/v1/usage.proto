// IMPORTANT: LOCKED SPEC. Only change with explicit migration.
syntax = "proto3";

package smallbiznis.usage.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/usage/v1;usagev1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/api/annotations.proto";

// UsageMetricType mirrors Stripe's aggregate_usage semantics so billing logic
// interprets COUNTER, GAUGE, and SUM in the same way Stripe would aggregate
// usage records.
enum UsageMetricType {
  USAGE_METRIC_TYPE_UNSPECIFIED = 0;
  COUNTER     = 1; // e.g. API calls (Stripe equivalent: sum)
  GAUGE       = 2; // e.g. concurrent connections (Stripe equivalent: last_during_period)
  SUM         = 3; // aggregated total for the window (Stripe equivalent: max/sum)
}

message UsageMetricDefinition {
  string           code        = 1; // e.g. "api_calls"
  string           name        = 2;
  string           description = 3; // human-readable detail for the metric
  UsageMetricType  type        = 4;
  string           unit        = 5; // "calls", "GB", etc
}

// Raw usage event
message UsageRecord {
  string                     id          = 1;
  // Tenant namespace that owns this usage (SmallBiznis Cloud or a tenant such as Company A).
  string                     tenant_id   = 2;
  string                     subscription_id = 3;
  string                     metric_code = 4 [deprecated = true]; // replaced by meter_id
  double                     value       = 5;
  google.protobuf.Timestamp  event_time  = 6;
  string                     idempotency_key = 7;
  google.protobuf.Struct     metadata    = 8;
  string                     meter_id    = 9;  // reference to Meter v2
  // Customer that generated this usage (Company A or its tenant-scoped customer).
  string                     customer_id = 10;
}

// UsageRecordedV2 is the payload emitted for usage.recorded.v2 events with customer context.
message UsageRecordedV2 {
  string                     id          = 1;
  // Tenant namespace that owns this usage (SmallBiznis Cloud or a tenant such as Company A).
  string                     tenant_id   = 2;
  // Customer that generated this usage (Company A or its downstream customer).
  string                     customer_id = 3;
  string                     subscription_id = 4;
  string                     meter_id    = 5;  // reference to Meter v2
  double                     value       = 6;
  google.protobuf.Timestamp  recorded_at = 7;
  string                     idempotency_key = 8;
  google.protobuf.Struct     metadata    = 9;
}

// Aggregated usage per window (hour/day/month)
message UsageAggregation {
  string                     tenant_id        = 1;
  string                     subscription_id  = 2;
  string                     metric_code      = 3 [deprecated = true];
  double                     total_value      = 4;
  google.protobuf.Timestamp  window_start     = 5;
  google.protobuf.Timestamp  window_end       = 6;
  string                     window_granularity = 7; // "hour", "day", "month"
  string                     meter_id         = 8;
}

message IngestUsageRequest {
  UsageRecord record = 1;
}

message IngestUsageResponse {
  string id = 1;
}

message ListUsageRequest {
  // Tenant namespace that owns the usage records (SmallBiznis Cloud or a tenant namespace).
  string tenant_id       = 1;
  string subscription_id = 2;
  string metric_code     = 3 [deprecated = true];
  google.protobuf.Timestamp from = 4;
  google.protobuf.Timestamp to   = 5;
  string meter_id        = 6;
  int32  page_size       = 10;
  string page_token      = 11;
  // Optional filter to list usage by the billed customer (Company A or its downstream customer).
  string customer_id     = 12;
}

message ListUsageResponse {
  repeated UsageRecord records        = 1;
  string               next_page_token = 2;
}

message GetUsageSummaryRequest {
  string tenant_id       = 1;
  string subscription_id = 2;
  string metric_code     = 3 [deprecated = true];
  google.protobuf.Timestamp from = 4;
  google.protobuf.Timestamp to   = 5;
  string meter_id        = 6;
}

message GetUsageSummaryResponse {
  repeated UsageAggregation aggregations = 1;
}

// Untuk daftar metric yang tersedia (dipakai UI / integrasi)
message ListUsageMetricsRequest {}

message ListUsageMetricsResponse {
  repeated UsageMetricDefinition metrics = 1;
}

service UsageService {

  rpc IngestUsage(IngestUsageRequest) returns (IngestUsageResponse) {
    option (google.api.http) = {
      post: "/v1/billing/usage"
      body: "*"
    };
  }

  rpc ListUsage(ListUsageRequest) returns (ListUsageResponse) {
    option (google.api.http) = {
      get: "/v1/billing/usage"
    };
  }

  rpc GetUsageSummary(GetUsageSummaryRequest) returns (GetUsageSummaryResponse) {
    option (google.api.http) = {
      get: "/v1/billing/usage/summary"
    };
  }

  rpc ListUsageMetrics(ListUsageMetricsRequest) returns (ListUsageMetricsResponse) {
    option (google.api.http) = {
      get: "/v1/billing/usage/metrics"
    };
  }
}
