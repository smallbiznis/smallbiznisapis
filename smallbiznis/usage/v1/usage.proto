syntax = "proto3";

package smallbiznis.usage.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/usage/v1;usagev1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";

// UsageRecord represents raw usage submitted by a tenant for a specific
// customer and subscription. Tenant identity must be validated via API key, but
// tenant_id remains on the record for internal flows and event fanout.
message UsageRecord {
  // Unique identifier for idempotent ingestion (Snowflake/ULID).
  string id = 1;
  // Tenant that owns the subscription and will be billed.
  string tenant_id = 2;
  // Customer that generated the usage and will be invoiced.
  string customer_id = 3;
  // Subscription under which this usage will be billed.
  string subscription_id = 4;
  // 
  string subscription_item_id = 5;
  // Canonical meter identifier that ties the usage to meter.v1.Meter.id even if codes change.
  string meter_id = 6;
  // Meter code defined by the tenant (per-tenant unique, e.g., "api_calls").
  double meter_code = 7;
  // Measured quantity for the meter (floating point to support fractional units).
  double value = 8;
  // Event time of the usage measurement.
  google.protobuf.Timestamp recorded_at = 9;
  // Idempotency key provided by the caller to deduplicate retries.
  string idempotency_key = 10;
  // Arbitrary metadata forwarded through rating and invoicing.
  google.protobuf.Struct metadata = 11;
}

// IngestUsageRequest accepts a single usage record for persistence.
message IngestUsageRequest {
  string customer_id = 1;
  string meter_code = 2;
  string value = 3;
  string idempotency_key = 4;
  google.protobuf.Timestamp recorded_at = 5;
  google.protobuf.Struct metadata = 6;
}

// IngestUsageResponse returns the canonical usage identifier after storage.
message IngestUsageResponse {
  string id = 1;
}

// ListUsageRequest filters usage records for querying and reconciliation.
message ListUsageRequest {
  string tenant_id = 1;
  string customer_id = 2;
  string subscription_id = 3;
  string subscription_item_id = 4;
  string meter_id = 5;
  google.protobuf.Timestamp from = 6;
  google.protobuf.Timestamp to = 7;
  int32 page_size = 20;
  string page_token = 21;
}

// ListUsageResponse contains a page of usage records matching the filters.
message ListUsageResponse {
  repeated UsageRecord records = 1;
  string next_page_token = 2;
}

// UsageService ingests tenant usage and exposes basic query capabilities for
// rating and reconciliation pipelines.
service UsageService {
  // Ingest a usage record provided by a tenant.
  rpc IngestUsage(IngestUsageRequest) returns (IngestUsageResponse) {
    option (google.api.http) = {
        post: "/v1/usage"
        body: "*"
    };
  };

  // List usage records for analytics or rerating operations.
  rpc ListUsage(ListUsageRequest) returns (ListUsageResponse);
}
