syntax = "proto3";

package smallbiznis.voucher.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/voucher/v1;voucherv1";

import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "google/protobuf/struct.proto";

// ========================================================
// ENUMS
// ========================================================

enum DiscountType {
  DISCOUNT_TYPE_UNSPECIFIED = 0;
  FIXED = 1;
  PERCENTAGE = 2;
}

enum IssuanceStatus {
  ISSUANCE_STATUS_UNSPECIFIED = 0;
  ISSUED = 1;
  REDEEMED = 2;
  EXPIRED = 3;
  CANCELED = 4;
}

// ========================================================
// ENTITIES
// ========================================================

// Voucher represents a redeemable entity (linked to a campaign).
message Voucher {
  string voucher_id = 1;
  string tenant_id = 2;
  string campaign_id = 3;
  string voucher_code = 4;
  string voucher_name = 5;

  DiscountType discount_type = 6;
  double discount_value = 7;         // 10.0 (percent) atau 50000.0 (fixed)
  string currency_code = 8;          // hanya relevan kalau FIXED

  google.protobuf.Timestamp expiry_date = 9;
  bool never_expires = 10;
  bool is_active = 11;
  google.protobuf.Struct metadata = 12;
  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp updated_at = 14;
}

message VoucherPool {
  string pool_id = 1;
  string tenant_id = 2;
  string campaign_id = 3;
  string name = 4;
  int32 total_stock = 5;
  int32 remaining_stock = 6;
  bool is_active = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

message VoucherPoolItem {
  string item_id = 1;
  string pool_id = 2;
  string voucher_code = 3; // voucher_code must be unique within the pool (or tenant), enforced at storage level.
  bool is_issued = 4;
  string issued_to = 5;
  google.protobuf.Timestamp issued_at = 6;
  google.protobuf.Struct metadata = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

// VoucherIssuance represents voucher assigned to a user.
message VoucherIssuance {
  string issuance_id = 1;
  string tenant_id = 2;
  string voucher_id = 3;
  string user_id = 4;
  IssuanceStatus status = 5;
  google.protobuf.Timestamp issued_at = 6;
  google.protobuf.Timestamp redeemed_at = 7;
  string order_id = 8;
  google.protobuf.Struct metadata = 9;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

// ========================================================
// SERVICE
// ========================================================

service VoucherService {

  // Admin: create voucher pool
  rpc CreateVoucherPool(CreateVoucherPoolRequest) returns (VoucherPool) {
    option (google.api.http) = {
      post: "/v1/voucherpools"
      body: "*"
    };
  }

  // Admin: bulk import voucher codes to pool
  rpc ImportVoucherPoolItems(ImportVoucherPoolItemsRequest) returns (ImportVoucherPoolItemsResponse) {
    option (google.api.http) = {
      post: "/v1/voucherpools/{pool_id}/items:import"
      body: "*"
    };
  }

  // Admin: list voucher pool and items
  rpc ListVoucherPools(ListVoucherPoolsRequest) returns (ListVoucherPoolsResponse) {
    option (google.api.http) = {
      get: "/v1/voucherpools"
    };
  }

  rpc GetVoucherPoolStock(GetVoucherPoolStockRequest) returns (GetVoucherPoolStockResponse) {
    option (google.api.http) = { get: "/v1/voucherpools/{pool_id}:stock" };
  }

  rpc ListVoucherPoolItems(ListVoucherPoolItemsRequest) returns (ListVoucherPoolItemsResponse) {
    option (google.api.http) = {
      get: "/v1/voucherpools/{pool_id}/items"
    };
  }

  // Evaluate voucher eligibility using DSL/CEL
  rpc EvaluateVouchers(EvaluateVouchersRequest) returns (EvaluateVouchersResponse) {
    option (google.api.http) = {
      post: "/v1/vouchers:evaluate"
      body: "*"
    };
  }

  // Issue voucher to a specific user (manual or auto)
  rpc IssueVoucher(IssueVoucherRequest) returns (IssueVoucherResponse) {
    option (google.api.http) = {
      post: "/v1/vouchers:issue"
      body: "*"
    };
  }

  // Redeem voucher (mark as used)
  rpc RedeemVoucher(RedeemVoucherRequest) returns (VoucherIssuance) {
    option (google.api.http) = {
      post: "/v1/vouchers:redeem"
      body: "*"
    };
  }

  // List all vouchers issued to a user
  rpc ListMyVouchers(ListMyVouchersRequest) returns (ListMyVouchersResponse) {
    option (google.api.http) = {
      get: "/v1/myvouchers"
    };
  }
}

// ========================================================
// REQUESTS / RESPONSES
// ========================================================

message CreateVoucherPoolRequest {
  string tenant_id = 1;
  string campaign_id = 2;
  string name = 3;
}

message ImportVoucherPoolItemsRequest {
  string tenant_id = 1;
  string pool_id = 2;
  repeated string voucher_codes = 3;
}

message ImportVoucherPoolItemsResponse {
  int32 imported = 1;
}

message ListVoucherPoolsRequest {
  string tenant_id = 1;
  bool only_active = 2;
}

message ListVoucherPoolsResponse {
  repeated VoucherPool pools = 1;
}

message ListVoucherPoolItemsRequest {
  string tenant_id = 1;
  string pool_id = 2;
  int32  limit = 3;         // default 50
  string cursor = 4;        // opaque (base64), optional
}

message ListVoucherPoolItemsResponse {
  repeated VoucherPoolItem items = 1;
  string next_cursor = 2;
}

message GetVoucherPoolStockRequest {
  string tenant_id = 1;
  string pool_id = 2;
}

message GetVoucherPoolStockResponse {
  string pool_id = 1;
  int32  remaining_stock = 2;
  bool   is_active = 3;
}

message EvaluateVouchersRequest {
  string tenant_id = 1;
  string user_id = 2;
  google.protobuf.Struct context = 3; // transaction, user, etc.
}

message EvaluateVouchersResponse {
  repeated VoucherEligibilityResult results = 1;
}

message VoucherEligibilityResult {
  string voucher_code = 1;
  bool eligible = 2;
  string reason = 3;
}

message IssueVoucherRequest {
  string tenant_id = 1;
  string user_id = 2;
  string campaign_id = 3;
  int32  count = 4;              // default 1
  string idempotency_key = 5;    // optional for safe retries
}

message IssueVoucherResponse {
  repeated VoucherIssuance issuances = 1;  // return per-user instances
}

message RedeemVoucherRequest {
  string tenant_id = 1;
  string user_id = 2;
  string voucher_code = 3;
  string order_id = 4;
}

message ListMyVouchersRequest {
  string tenant_id = 1;
  string user_id   = 2;
  IssuanceStatus status = 3;  // optional filter (enum, bukan string)
  string campaign_id = 4;     // optional
  int32  limit = 5;
  string cursor = 6;
}

message ListMyVouchersResponse {
  repeated VoucherIssuance vouchers = 1;
  string next_cursor = 2;
}
