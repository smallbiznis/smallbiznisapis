syntax = "proto3";

package smallbiznis.voucher.v1;

option go_package = "github.com/smallbiznis/go-genproto/smallbiznis/voucher/v1;voucherv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// ======================================================
// ENUMS
// ======================================================

enum VoucherType {
  VOUCHER_TYPE_UNSPECIFIED = 0;
  FIXED = 1;      // potongan nominal (IDR)
  PERCENT = 2;    // potongan % (0-100)
}

enum VoucherStatus {
  VOUCHER_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  REDEEMED = 2;
  EXPIRED = 3;
  DISABLED = 4;
}

enum VoucherPoolStatus {
  VOUCHER_POOL_STATUS_UNSPECIFIED = 0;
  POOL_ACTIVE = 1;
  POOL_INACTIVE = 2;
}

// ======================================================
// MODELS
// ======================================================

message VoucherPool {
  string id = 1;
  string tenant_id = 2;

  string name = 3;
  string description = 4;

  int64 total_issued = 5;
  int64 total_redeemed = 6;

  VoucherPoolStatus status = 7;

  google.protobuf.Struct metadata = 8;

  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

// full voucher code
message Voucher {
  string id = 1;
  string tenant_id = 2;

  string pool_id = 3;
  string code = 4;

  VoucherType type = 5;

  // for FIXED: discount_value_cents
  // for PERCENT: percentage (0-100)
  int64 discount_value_cents = 6;
  int32 discount_percent = 7;

  // min requirement
  int64 min_spend_cents = 8;

  // constraint: product or category or variant
  repeated string product_ids = 9;
  repeated string category_ids = 10;

  VoucherStatus status = 11;

  google.protobuf.Timestamp issued_at = 12;
  google.protobuf.Timestamp redeemed_at = 13;
  google.protobuf.Timestamp expired_at = 14;

  string issued_to_user_id = 15;
  string redeemed_order_id = 16;

  google.protobuf.Struct metadata = 17;

  google.protobuf.Timestamp created_at = 18;
  google.protobuf.Timestamp updated_at = 19;
}

// ======================================================
// EVENTS
// ======================================================

message VoucherIssuedEvent {
  string voucher_id = 1;
  string tenant_id = 2;
  string user_id = 3;
  string pool_id = 4;
  google.protobuf.Timestamp occurred_at = 5;
}

message VoucherRedeemedEvent {
  string voucher_id = 1;
  string tenant_id = 2;
  string order_id = 3;
  int64 discount_applied = 4;
  google.protobuf.Timestamp occurred_at = 5;
}

// ======================================================
// REQUESTS / RESPONSES
// ======================================================

// ----- CREATE POOL -----

message CreateVoucherPoolRequest {
  string tenant_id = 1;
  string name = 2;
  string description = 3;
  google.protobuf.Struct metadata = 4;
}

message CreateVoucherPoolResponse {
  VoucherPool pool = 1;
}

message ListVoucherPoolsRequest {
  string tenant_id = 1;
}

message ListVoucherPoolsResponse {
  repeated VoucherPool pools = 1;
}

// ----- ISSUE VOUCHERS -----

message IssueVouchersRequest {
  string tenant_id = 1;
  string pool_id = 2;

  int32 quantity = 3;

  // voucher type
  VoucherType type = 4;
  int64 discount_value_cents = 5;
  int32 discount_percent = 6;

  int64 min_spend_cents = 7;

  repeated string product_ids = 8;
  repeated string category_ids = 9;

  google.protobuf.Timestamp expired_at = 10;

  // code generation
  string prefix = 11;
  string suffix = 12;
  int32 code_length = 13; // excluding prefix/suffix

  google.protobuf.Struct metadata = 14;
}

message IssueVouchersResponse {
  repeated Voucher vouchers = 1;
}

// ----- REDEEM -----

message RedeemVoucherRequest {
  string tenant_id = 1;
  string code = 2;

  string order_id = 3;
  int64 order_total_cents = 4;
  repeated string order_product_ids = 5;
}

message RedeemVoucherResponse {
  Voucher voucher = 1;
  int64 discount_applied_cents = 2;
}

// ----- GET -----

message GetVoucherRequest {
  string id = 1;
}

message GetVoucherResponse {
  Voucher voucher = 1;
}

message GetVoucherByCodeRequest {
  string tenant_id = 1;
  string code = 2;
}

message GetVoucherByCodeResponse {
  Voucher voucher = 1;
}

message ListVouchersRequest {
  string tenant_id = 1;
  string pool_id = 2;
  VoucherStatus status_filter = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message ListVouchersResponse {
  repeated Voucher vouchers = 1;
  string next_page_token = 2;
}

// ======================================================
// SERVICE
// ======================================================

service VoucherService {

  // ---- POOL ----

  rpc CreateVoucherPool(CreateVoucherPoolRequest)
      returns (CreateVoucherPoolResponse) {
    option (google.api.http) = {
      post: "/v1/voucher-pools"
      body: "*"
    };
  }

  rpc ListVoucherPools(ListVoucherPoolsRequest)
      returns (ListVoucherPoolsResponse) {
    option (google.api.http) = {
      get: "/v1/voucher-pools"
    };
  }

  // ---- ISSUE ----

  rpc IssueVouchers(IssueVouchersRequest)
      returns (IssueVouchersResponse) {
    option (google.api.http) = {
      post: "/v1/voucher-pools/{pool_id}/issue"
      body: "*"
    };
  }

  // ---- REDEEM ----

  rpc RedeemVoucher(RedeemVoucherRequest)
      returns (RedeemVoucherResponse) {
    option (google.api.http) = {
      post: "/v1/vouchers:redeem"
      body: "*"
    };
  }

  // ---- GET ----

  rpc GetVoucher(GetVoucherRequest)
      returns (GetVoucherResponse) {
    option (google.api.http) = {
      get: "/v1/vouchers/{id}"
    };
  }

  rpc GetVoucherByCode(GetVoucherByCodeRequest)
      returns (GetVoucherByCodeResponse) {
    option (google.api.http) = {
      get: "/v1/vouchers:by-code"
    };
  }

  rpc ListVouchers(ListVouchersRequest)
      returns (ListVouchersResponse) {
    option (google.api.http) = {
      get: "/v1/vouchers"
    };
  }
}
